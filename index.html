<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធស្កេនវត្តមានដោយប្រើផ្ទៃមុខ</title>
    <!-- Use Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import face-api.js for face recognition -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- Import Google Fonts for Khmer text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        /* Custom spinner animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3b82f6; /* blue-500 */
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #video-container {
            position: relative;
            width: 720px;
            height: 560px;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-6xl mx-auto">
        
        <!-- Setup View: Ask for API Key -->
        <div id="setup-view" class="bg-gray-800 p-8 rounded-lg shadow-xl text-center">
            <h1 class="text-3xl font-bold mb-4">ប្រព័ន្ធស្កេនវត្តមាន</h1>
            <p class="text-gray-400 mb-6">សូមបញ្ចូល Google Sheets API Key ដើម្បីចាប់ផ្តើមទាញទិន្នន័យ។</p>
            <div class="max-w-md mx-auto">
                <input type="password" id="apiKeyInput" class="w-full bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="បញ្ចូល API Key នៅទីនេះ...">
                <button id="startButton" class="w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded-md mt-4 transition duration-300">ចាប់ផ្តើមប្រព័ន្ធ</button>
            </div>
            <p class="text-xs text-yellow-500 mt-4">
                <strong>បញ្ជាក់៖</strong> API Key របស់អ្នកនឹងបង្ហាញនៅក្នុងកូដរបស់ Browser។ សូមប្រើប្រាស់ដោយការទទួលខុសត្រូវ និងកុំចែករំលែកជាសាធារណៈ។
            </p>
            <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-blue-400 hover:underline mt-2 inline-block text-sm">របៀបបង្កើត API Key</a>
        </div>

        <!-- Loading View -->
        <div id="loading-view" class="hidden flex-col items-center justify-center text-center bg-gray-800 p-8 rounded-lg shadow-xl">
            <div class="spinner mb-4"></div>
            <p id="loading-text" class="text-xl">កំពុងរៀបចំប្រព័ន្ធ...</p>
        </div>

        <!-- Main Application View -->
        <div id="main-view" class="hidden flex flex-col lg:flex-row gap-8">
            <!-- Camera and Result Section -->
            <div class="flex-1 bg-gray-800 p-6 rounded-lg shadow-xl flex flex-col items-center">
                <h2 class="text-2xl font-bold mb-4">ស្កេនផ្ទៃមុខ</h2>
                <div id="video-container" class="bg-black rounded-md overflow-hidden shadow-inner">
                    <video id="video" width="720" height="560" autoplay muted playsinline></video>
                    <canvas id="overlay"></canvas>
                </div>
            </div>

            <!-- Matched Information Section -->
            <div class="w-full lg:w-96 bg-gray-800 p-6 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold mb-4 text-center">លទ្ធផលស្កេន</h2>
                <div id="result-card" class="hidden bg-gray-700 rounded-lg p-4 text-center">
                    <img id="result-photo" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-blue-500 object-cover" src="https://placehold.co/128x128/374151/FFFFFF?text=Photo" alt="រូបថតបុគ្គលិក">
                    <h3 id="result-name" class="text-xl font-bold"></h3>
                    <p id="result-id" class="text-gray-300"></p>
                    <div class="text-left mt-4 space-y-2">
                        <p><strong>ភេទ៖</strong> <span id="result-gender"></span></p>
                        <p><strong>ក្រុម៖</strong> <span id="result-group"></span></p>
                        <p><strong>ផ្នែក៖</strong> <span id="result-department"></span></p>
                        <p><strong>ថ្នាក់៖</strong> <span id="result-class"></span></p>
                        <p class="font-bold text-green-400"><strong>ម៉ោងស្កេន៖</strong> <span id="result-time"></span></p>
                    </div>
                </div>
                <div id="no-result" class="flex items-center justify-center h-full text-gray-400">
                    <p>សូមដាក់មុខរបស់លោកអ្នកនៅចំពីមុខកាមេរ៉ា...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const setupView = document.getElementById('setup-view');
        const loadingView = document.getElementById('loading-view');
        const mainView = document.getElementById('main-view');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const startButton = document.getElementById('startButton');
        const loadingText = document.getElementById('loading-text');
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');

        const resultCard = document.getElementById('result-card');
        const noResult = document.getElementById('no-result');
        const resultPhoto = document.getElementById('result-photo');
        const resultName = document.getElementById('result-name');
        const resultId = document.getElementById('result-id');
        const resultGender = document.getElementById('result-gender');
        const resultGroup = document.getElementById('result-group');
        const resultDepartment = document.getElementById('result-department');
        const resultClass = document.getElementById('result-class');
        const resultTime = document.getElementById('result-time');
        
        // --- Google Sheet Configuration ---
        const SPREADSHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
        const SHEET_NAME = 'DIList';
        // Define the full range to fetch all necessary columns
        const DATA_RANGE = 'E9:AJ';

        let faceMatcher = null;
        let detectionInterval = null;

        // Load all necessary models from face-api.js
        async function loadModels() {
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            loadingText.innerText = 'កំពុងទាញយក Model...';
            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
        }

        // Start the webcam
        async function startVideo() {
            try {
                loadingText.innerText = 'កំពុងចាប់ផ្តើម​កាមេរ៉ា...';
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
            } catch (err) {
                console.error("Error accessing webcam: ", err);
                loadingText.innerText = 'Error: មិនអាចបើកកាមេរ៉ាបានទេ។ សូមអនុញ្ញាតឱ្យ Browser ប្រើប្រាស់កាមេរ៉ា។';
            }
        }
        
        // Extract URL from Google Sheet's IMAGE formula
        function extractImageUrl(formula) {
            if (!formula || typeof formula !== 'string') return null;
            const match = formula.match(/=IMAGE\("([^"]+)"\)/);
            return match ? match[1] : null;
        }

        // Fetch data from Google Sheets and prepare labeled face descriptors
        async function loadLabeledImages(apiKey) {
            loadingText.innerText = 'កំពុងទាញយកទិន្នន័យពី Google Sheet...';
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}!${DATA_RANGE}?key=${apiKey}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const values = data.values;
                if (!values || values.length === 0) {
                    loadingText.innerText = 'Error: រកមិនឃើញទិន្នន័យក្នុង Sheet ទេ។';
                    return null;
                }

                loadingText.innerText = `រកឃើញ ${values.length} នាក់។ កំពុងដំណើរការរូបថត...`;

                const labeledFaceDescriptors = [];
                let processedCount = 0;
                
                for (const row of values) {
                    // Column mapping based on DATA_RANGE 'E9:AJ' (0-indexed)
                    const id = row[0];        // Column E
                    const group = row[2];     // Column G
                    const name = row[7];      // Column L
                    const gender = row[9];    // Column N
                    const class_ = row[13];   // Column R
                    const department = row[14]; // Column S
                    const photoFormula = row[31]; // Column AJ

                    const imageUrl = extractImageUrl(photoFormula);

                    if (name && imageUrl) {
                        try {
                            const img = await faceapi.fetchImage(imageUrl);
                            const detections = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                            if (detections) {
                                const descriptors = [detections.descriptor];
                                const labelData = {
                                    _label: name,
                                    _userData: { id, group, name, gender, class_, department, imageUrl }
                                };
                                labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(labelData._label, descriptors, labelData._userData));
                            }
                        } catch (e) {
                            console.error(`Could not process image for ${name}:`, e);
                        }
                    }
                    processedCount++;
                    loadingText.innerText = `កំពុងដំណើរការរូបថត... (${processedCount}/${values.length})`;
                }

                if (labeledFaceDescriptors.length === 0) {
                    loadingText.innerText = 'Error: មិនអាចដំណើរការរូបថតណាមួយបានទេ។ សូមពិនិត្យ Link រូបភាព។';
                    return null;
                }
                
                return new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55);

            } catch (err) {
                console.error("Error fetching sheet data: ", err);
                loadingText.innerText = `Error: ${err.message}. សូមពិនិត្យ API Key ឬ Sheet Permissions។`;
                return null;
            }
        }
        
        // Main function to initialize the system
        startButton.addEventListener('click', async () => {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                alert('សូមបញ្ចូល Google Sheets API Key!');
                return;
            }
            
            setupView.classList.add('hidden');
            loadingView.classList.remove('hidden');
            loadingView.classList.add('flex');

            await loadModels();
            faceMatcher = await loadLabeledImages(apiKey);
            
            if (faceMatcher) {
                await startVideo();
            } else {
                 // Error occurred, show setup again to allow re-entry of key
                 setTimeout(() => {
                    loadingView.classList.add('hidden');
                    loadingView.classList.remove('flex');
                    setupView.classList.remove('hidden');
                }, 3000);
            }
        });

        // Event listener for when the video starts playing
        video.addEventListener('play', () => {
            if (!faceMatcher) return;

            loadingView.classList.add('hidden');
            mainView.classList.remove('hidden');
            mainView.classList.add('flex');
            
            // Adjust canvas size to match video display size
            const displaySize = { width: video.width, height: video.height };
            faceapi.matchDimensions(overlay, displaySize);

            let lastMatchTime = 0;
            let lastMatchName = null;
            const displayDelay = 3000; // 3 seconds delay before showing same person again
            
            detectionInterval = setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                
                overlay.getContext('2d').clearRect(0, 0, overlay.width, overlay.height);
                faceapi.draw.drawDetections(overlay, resizedDetections);

                const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
                
                if (results.length > 0 && results[0].label !== 'unknown') {
                    const bestMatch = results[0];
                    const currentTime = Date.now();
                    
                    if (bestMatch.label !== lastMatchName || (currentTime - lastMatchTime > displayDelay)) {
                        lastMatchName = bestMatch.label;
                        lastMatchTime = currentTime;

                        const userData = faceMatcher.labeledDescriptors.find(ld => ld.label === bestMatch.label).userData;

                        resultPhoto.src = userData.imageUrl;
                        resultName.innerText = userData.name;
                        resultId.innerText = `អត្តលេខ៖ ${userData.id || 'N/A'}`;
                        resultGender.innerText = userData.gender || 'N/A';
                        resultGroup.innerText = userData.group || 'N/A';
                        resultDepartment.innerText = userData.department || 'N/A';
                        resultClass.innerText = userData.class_ || 'N/A';
                        resultTime.innerText = new Date().toLocaleTimeString('en-GB');

                        resultCard.classList.remove('hidden');
                        noResult.classList.add('hidden');
                    }
                } else {
                    lastMatchName = null; // Reset if no face or unknown face is detected
                    // Optionally hide the card after a while if no face is detected
                }
            }, 200);
        });

    </script>
</body>
</html>
