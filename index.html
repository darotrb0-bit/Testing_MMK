<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធវត្តមានបុគ្គលិក</title>
    <!-- Chosen Palette: Cool Blues & Grays -->
    <!-- Application Structure Plan: The SPA is redesigned into a modern, single-view dashboard. The layout is split into two main columns on wider screens: the left column is the "action" area, featuring a large, interactive camera preview with dynamic feedback. The right column is the "information" area, displaying a real-time log of the latest 8 scans. This two-column structure is chosen for clear separation of concerns: 'doing' (scanning) vs. 'seeing' (results). On mobile, it stacks vertically. A central, modal-like result panel appears upon a successful scan, providing clear, focused feedback without cluttering the main UI. This architecture prioritizes immediate user feedback and a clean, uncluttered interface, which enhances usability and perceived performance. -->
    <!-- Visualization & Content Choices: 
    - Report Info: Employee list, schedules, photos -> Goal: Identify User -> Presentation: Live Camera Feed -> Interaction: Automatic face detection -> Justification: Core functionality of the app. UI is redesigned for better feedback. -> Library/Method: Vanilla JS + face-api.js.
    - Report Info: Check-in/Check-out status for the day -> Goal: Prevent Duplicates & Inform -> Presentation: In-memory JS object (`attendanceLog`) synced from Google Sheet on load -> Interaction: App logic checks this object before allowing a check-in/out -> Justification: This is the most critical enhancement for data accuracy, moving beyond unreliable localStorage. -> Library/Method: Vanilla JS Fetch API calling Google Apps Script `doGet`.
    - Report Info: Log of recent scans (Name, action, time) -> Goal: Provide real-time context and confirmation -> Presentation: Dynamic HTML list with cards -> Interaction: List updates automatically after each successful scan -> Justification: Gives users immediate confirmation that their action was recorded and shows recent activity, creating a sense of a live system. -> Library/Method: Vanilla JS DOM manipulation.
    - NO charts are needed for this report. The focus is on status and lists. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Kantumruy+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Kantumruy Pro', sans-serif; }
        .font-khmer { font-family: 'Kantumruy Pro', sans-serif; }
        .camera-wrapper {
            position: relative;
            width: 400px;
            height: 400px;
            margin: auto;
            border-radius: 50%;
            overflow: hidden;
            border: 10px solid #f0f4f8;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05);
        }
        #video, #video-register, #login-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.8), transparent);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
            animation: scan 3s linear infinite;
            opacity: 0;
        }
        .scanning .scan-line { opacity: 1; }
        @keyframes scan {
            0% { transform: translateY(0); }
            100% { transform: translateY(400px); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-slate-100 z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl">
            <h1 class="text-3xl font-bold text-slate-900 font-khmer text-center mb-2">ចូលប្រព័ន្ធ Admin</h1>
            <p class="text-slate-500 text-center mb-6">សូមជ្រើសរើសវិធីសាស្ត្រចូល</p>
            <div class="flex border-b border-slate-200 mb-6">
                <button id="tab-face" class="flex-1 py-3 text-center font-bold text-blue-600 border-b-2 border-blue-600 font-khmer">ស្កេនមុខ</button>
                <button id="tab-pass" class="flex-1 py-3 text-center font-bold text-slate-500 font-khmer">ពាក្យសម្ងាត់</button>
            </div>

            <!-- Face Scan Tab -->
            <div id="face-scan-panel">
                <div class="w-56 h-56 mx-auto rounded-full overflow-hidden border-4 border-slate-200 mb-4">
                    <video id="login-video" autoplay muted playsinline></video>
                </div>
                <p id="login-status" class="text-center font-medium text-sm h-6"></p>
            </div>

            <!-- Password Tab -->
            <div id="password-panel" class="hidden">
                 <button id="request-otp-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 transition font-khmer text-lg mb-4">
                    ស្នើសុំពាក្យសម្ងាត់
                </button>
                <input type="number" id="otp-input" class="w-full text-center text-2xl tracking-[1em] px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-4" placeholder="------" maxlength="6" disabled>
                <button id="verify-otp-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-blue-700 transition font-khmer text-lg disabled:bg-slate-400" disabled>
                    ចូល
                </button>
                <p id="otp-status" class="text-center font-medium text-sm h-6 mt-4"></p>
            </div>
        </div>
    </div>


    <div id="start-overlay" class="fixed inset-0 bg-slate-100 z-50 flex-col items-center justify-center transition-opacity duration-500 hidden">
        <div class="text-center">
            <h1 class="text-4xl font-bold text-slate-900 font-khmer">ប្រព័ន្ធកត់ត្រាវត្តមាន</h1>
            <p class="text-slate-500 mt-2 mb-8">សូមជ្រើសរើសមុខងារខាងក្រោម</p>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="start-scan-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 font-khmer text-lg">
                    ស្កេនវត្តមាន
                </button>
                <button id="start-register-btn-main" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300 font-khmer text-lg">
                    ចុះឈ្មោះថ្មី
                </button>
            </div>
        </div>
    </div>

    <div id="loader" class="fixed inset-0 bg-white z-40 flex-col items-center justify-center transition-opacity duration-500 hidden">
        <svg class="animate-spin h-10 w-10 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <h2 id="loader-text" class="text-slate-600 font-medium font-khmer">កំពុងរៀបចំប្រព័ន្ធ...</h2>
        <p class="text-sm text-slate-400 mt-2">សូមមេត្តារង់ចាំបន្តិច</p>
    </div>
    
    <!-- Registration Modal -->
    <div id="registration-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg m-4">
            <h2 class="text-2xl font-bold text-slate-800 font-khmer text-center mb-6">ចុះឈ្មោះមុខថ្មី</h2>
            
            <div class="mb-4">
                <label for="employee-select-input" class="block text-sm font-medium text-slate-700 font-khmer mb-1">ជ្រើសរើសបុគ្គលិក</label>
                <input id="employee-select-input" list="employee-list" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="វាយឈ្មោះ ឬអត្តលេខ...">
                <datalist id="employee-list"></datalist>
            </div>

            <div class="w-64 h-64 mx-auto rounded-full overflow-hidden border-4 border-slate-200 mb-4 relative">
                 <video id="video-register" autoplay muted playsinline class="w-full h-full object-cover"></video>
                 <img id="captured-image-preview" class="w-full h-full object-cover hidden" style="transform: scaleX(-1);">
            </div>
            <canvas id="canvas-capture" class="hidden"></canvas>

            <p id="registration-status" class="text-center text-sm font-medium h-6 mb-4"></p>

            <div class="flex items-center justify-center gap-4">
                <button id="capture-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition font-khmer disabled:bg-slate-300" disabled>ថតរូប</button>
                <button id="retake-btn" class="bg-amber-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-amber-600 transition font-khmer hidden">ថតម្ដងទៀត</button>
                <button id="save-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition font-khmer disabled:bg-slate-300 hidden" disabled>រក្សាទុក</button>
                <button id="cancel-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 transition font-khmer">បោះបង់</button>
            </div>
        </div>
    </div>


    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 opacity-0 transition-opacity duration-500 hidden">
        <header class="text-center mb-10 relative">
            <h1 class="text-4xl font-bold text-slate-900 font-khmer">ប្រព័ន្ធកត់ត្រាវត្តមាន</h1>
            <p class="text-slate-500 mt-2">ស្កេនផ្ទៃមុខដើម្បី Check-in ឬ Check-out</p>
             <button id="start-registration-btn" class="absolute top-0 right-0 bg-indigo-100 text-indigo-700 font-bold py-2 px-4 rounded-lg hover:bg-indigo-200 transition font-khmer text-sm">
                ចុះឈ្មោះមុខថ្មី
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-12 items-start">
            <section class="lg:col-span-3 bg-white p-8 rounded-2xl shadow-lg">
                <div id="camera-container" class="camera-wrapper">
                    <video id="video" autoplay muted playsinline></video>
                    <div class="scan-line"></div>
                </div>
                <div id="match-result" class="text-center mt-6 h-32"></div>
            </section>

            <aside class="lg:col-span-2 bg-white p-8 rounded-2xl shadow-lg h-full">
                <h3 class="text-xl font-bold text-center text-slate-700 mb-6 font-khmer">សកម្មភាពចុងក្រោយ</h3>
                <div class="space-y-4 max-h-[440px] overflow-y-auto pr-2">
                    <ul id="recent-scans-list" class="divide-y divide-slate-100">
                        <li id="no-scans-placeholder" class="py-10 text-center text-slate-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p class="mt-2 text-sm font-medium font-khmer">មិនទាន់មានសកម្មភាព</p>
                        </li>
                    </ul>
                </div>
            </aside>
        </div>
    </main>

    <script>
        // Main UI elements
        const startOverlay = document.getElementById('start-overlay');
        const startScanBtn = document.getElementById('start-scan-btn');
        const startRegisterBtnMain = document.getElementById('start-register-btn-main');
        const video = document.getElementById('video');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const mainContent = document.querySelector('main');
        const cameraContainer = document.getElementById('camera-container');
        const matchResultContainer = document.getElementById('match-result');
        const recentScansList = document.getElementById('recent-scans-list');
        const noScansPlaceholder = document.getElementById('no-scans-placeholder');

        // Login Elements
        const loginOverlay = document.getElementById('login-overlay');
        const loginVideo = document.getElementById('login-video');
        const loginStatus = document.getElementById('login-status');
        const tabFace = document.getElementById('tab-face');
        const tabPass = document.getElementById('tab-pass');
        const faceScanPanel = document.getElementById('face-scan-panel');
        const passwordPanel = document.getElementById('password-panel');
        const requestOtpBtn = document.getElementById('request-otp-btn');
        const otpInput = document.getElementById('otp-input');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const otpStatus = document.getElementById('otp-status');


        // Registration Modal Elements
        const registrationOverlay = document.getElementById('registration-overlay');
        const startRegistrationBtn = document.getElementById('start-registration-btn');
        const videoRegister = document.getElementById('video-register');
        const capturedImagePreview = document.getElementById('captured-image-preview');
        const employeeSelectInput = document.getElementById('employee-select-input');
        const employeeList = document.getElementById('employee-list');
        const registrationStatus = document.getElementById('registration-status');
        const captureBtn = document.getElementById('capture-btn');
        const saveBtn = document.getElementById('save-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const canvasCapture = document.getElementById('canvas-capture');


        const EMPLOYEE_SHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
        const EMPLOYEE_SHEET_NAME = 'DIList';
        const PUBLISHED_CSV_URL = `https://docs.google.com/spreadsheets/d/${EMPLOYEE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${EMPLOYEE_SHEET_NAME}`;
        const APPS_SCRIPT_URL = 'YOUR_NEW_APPS_SCRIPT_URL'; // !!! IMPORTANT: UPDATE THIS URL AFTER DEPLOYING NEW SCRIPT
        const ADMIN_IMAGE_URL = 'https://i.postimg.cc/0QCDrW4d/photo-2025-09-27-15-47-14.jpg';

        const attendanceLog = {};
        let processing = false;
        let recentScans = [];
        let faceMatcher = null;
        let allEmployees = [];
        let registrationStream = null;
        let isDetectionRunning = false;
        let loginStream = null;
        let otpTimerInterval = null;

        // --- Start of App ---
        document.addEventListener('DOMContentLoaded', initializeLogin);
        

        // --- Login Logic ---
        async function initializeLogin() {
            loginStatus.textContent = 'កំពុងដំណើរការម៉ូឌែល...';
            const modelUrl = './models';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(modelUrl),
                faceapi.nets.faceLandmark68Net.loadFromUri(modelUrl),
                faceapi.nets.faceRecognitionNet.loadFromUri(modelUrl),
                faceapi.nets.faceExpressionNet.loadFromUri(modelUrl)
            ]);
            loginStatus.textContent = 'សូមដាក់មុខចំកាមេរ៉ា';
            startLoginCamera();
        }

        async function startLoginCamera() {
            try {
                loginStream = await navigator.mediaDevices.getUserMedia({ video: {} });
                loginVideo.srcObject = loginStream;
                loginVideo.addEventListener('play', startAdminFaceDetection);
            } catch(err) {
                loginStatus.textContent = 'មិនអាចបើកកាមេរ៉ាបានទេ';
                loginStatus.classList.add('text-red-600');
            }
        }

        function stopLoginCamera() {
             if (loginStream) {
                loginStream.getTracks().forEach(track => track.stop());
                loginStream = null;
            }
        }

        async function startAdminFaceDetection() {
            loginStatus.textContent = 'កំពុងរៀបចំទិន្នន័យ Admin...';
            const adminImg = await faceapi.fetchImage(ADMIN_IMAGE_URL);
            const adminDetection = await faceapi.detectSingleFace(adminImg, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            
            if (!adminDetection) {
                loginStatus.textContent = 'មិនអាចវិភាគមុខ Admin បានទេ';
                loginStatus.classList.add('text-red-600');
                return;
            }

            const adminMatcher = new faceapi.FaceMatcher([adminDetection.descriptor], 0.5);
            loginStatus.textContent = 'ត្រៀមខ្លួនស្កេន...';

            const detect = async () => {
                if (!loginStream) return;
                const detection = await faceapi.detectSingleFace(loginVideo, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                if (detection) {
                    const bestMatch = adminMatcher.findBestMatch(detection.descriptor);
                    if (bestMatch.label === 'person 1') { // Default label for single descriptor
                        loginSuccess();
                    }
                }
                if (loginStream) requestAnimationFrame(detect);
            };
            detect();
        }
        
        tabFace.addEventListener('click', () => {
            faceScanPanel.classList.remove('hidden');
            passwordPanel.classList.add('hidden');
            tabFace.classList.add('text-blue-600', 'border-blue-600');
            tabPass.classList.remove('text-blue-600', 'border-blue-600');
            tabPass.classList.add('text-slate-500');
            if(!loginStream) startLoginCamera();
        });

        tabPass.addEventListener('click', () => {
            passwordPanel.classList.remove('hidden');
            faceScanPanel.classList.add('hidden');
            tabPass.classList.add('text-blue-600', 'border-blue-600');
            tabFace.classList.remove('text-blue-600', 'border-blue-600');
            tabFace.classList.add('text-slate-500');
            stopLoginCamera();
        });

        requestOtpBtn.addEventListener('click', async () => {
            requestOtpBtn.disabled = true;
            requestOtpBtn.textContent = 'កំពុងផ្ញើ...';
            otpStatus.textContent = '';
            otpStatus.classList.remove('text-red-600', 'text-green-600');

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'request_otp' }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    otpInput.disabled = false;
                    verifyOtpBtn.disabled = false;
                    otpStatus.textContent = 'ពាក្យសម្ងាត់បានផ្ញើទៅ Telegram ហើយ';
                    otpStatus.classList.add('text-green-600');
                    let timeLeft = 60;
                    requestOtpBtn.textContent = `ព្យាយាមម្តងទៀត (${timeLeft}វិនាទី)`;
                    otpTimerInterval = setInterval(() => {
                        timeLeft--;
                        requestOtpBtn.textContent = `ព្យាយាមម្តងទៀត (${timeLeft}វិនាទី)`;
                        if (timeLeft <= 0) {
                            clearInterval(otpTimerInterval);
                            requestOtpBtn.disabled = false;
                            requestOtpBtn.textContent = 'ស្នើសុំពាក្យសម្ងាត់';
                            otpStatus.textContent = 'ពាក្យសម្ងាត់បានអស់សុពលភាព';
                            otpStatus.classList.add('text-red-600');
                        }
                    }, 1000);
                } else {
                    throw new Error(result.message);
                }
            } catch (err) {
                otpStatus.textContent = 'ការស្នើសុំមានបញ្ហា';
                otpStatus.classList.add('text-red-600');
                requestOtpBtn.disabled = false;
                requestOtpBtn.textContent = 'ស្នើសុំពាក្យសម្ងាត់';
            }
        });

        verifyOtpBtn.addEventListener('click', async () => {
            const otp = otpInput.value;
            if (otp.length !== 6) {
                otpStatus.textContent = 'សូមបញ្ចូលពាក្យសម្ងាត់ ៦ ខ្ទង់';
                otpStatus.classList.add('text-red-600');
                return;
            }
            verifyOtpBtn.disabled = true;
            verifyOtpBtn.textContent = 'កំពុងផ្ទៀងផ្ទាត់...';

             try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'verify_otp', otp: otp }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    loginSuccess();
                } else {
                    throw new Error(result.message);
                }
            } catch (err) {
                otpStatus.textContent = err.message || 'ពាក្យសម្ងាត់មិនត្រឹមត្រូវ';
                otpStatus.classList.add('text-red-600');
                verifyOtpBtn.disabled = false;
                verifyOtpBtn.textContent = 'ចូល';
            }
        });

        function loginSuccess() {
            stopLoginCamera();
            loginOverlay.classList.add('opacity-0');
            startOverlay.classList.remove('hidden');
            startOverlay.style.display = 'flex';
            setTimeout(() => {
                loginOverlay.style.display = 'none';
            }, 500);
        }

        // --- Main App Logic ---
        async function handleStart(isRegistration = false) {
            startOverlay.classList.add('opacity-0');
            loader.classList.remove('hidden');
            loader.style.display = 'flex';
            
            setTimeout(async () => {
                startOverlay.style.display = 'none';

                const success = await initializeCoreApp();
                if (!success) return;

                loader.classList.add('opacity-0');
                setTimeout(() => loader.style.display = 'none', 500);

                if (isRegistration) {
                    startRegistrationBtn.click();
                } else {
                    mainContent.classList.remove('hidden');
                    mainContent.classList.remove('opacity-0');
                    await startCamera();
                }
            }, 500);
        }

        startScanBtn.addEventListener('click', () => handleStart(false));
        startRegisterBtnMain.addEventListener('click', () => handleStart(true));
        
        async function initializeCoreApp() {
             try {
                updateLoader('កំពុងដំណើរការម៉ូឌែលសម្គាល់...');
                const modelUrl = './models';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(modelUrl),
                    faceapi.nets.faceLandmark68Net.loadFromUri(modelUrl),
                    faceapi.nets.faceRecognitionNet.loadFromUri(modelUrl)
                ]);
                
                updateLoader('កំពុងទាញទិន្នន័យ...');
                await loadSheetData();
                return true;
            } catch (error) {
                console.error("Core Initialization failed:", error);
                updateLoader('ការរៀបចំប្រព័ន្ធមានបញ្ហា។');
                return false;
            }
        }
        
        async function loadSheetData(){
            await loadInitialAttendanceState();
            const labeledFaceDescriptors = await getLabeledFaceDescriptors();
            if (labeledFaceDescriptors && labeledFaceDescriptors.length > 0) {
                faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55);
            } else {
                console.error('Could not create face matcher.');
            }
        }

        async function loadInitialAttendanceState() {
             if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('YOUR_GOOGLE')) return;
            try {
                const response = await fetch(APPS_SCRIPT_URL);
                const result = await response.json();
                if (result.status === 'success' && result.log) {
                    Object.assign(attendanceLog, result.log);
                }
            } catch (error) {
                console.error('Failed to fetch initial attendance state:', error);
            }
        }

        async function getLabeledFaceDescriptors() {
            const response = await fetch(`${PUBLISHED_CSV_URL}&t=${new Date().getTime()}`);
            const csvText = await response.text();
            const rows = csvText.split('\n').slice(8).map(row => row.replace(/"/g, '').split(','));
            
            const employees = rows.map(row => {
                const newImageUrl = row[35]; // Column AJ
                const oldImageUrl = row[26]; // Column AA
                return {
                    id: row[4],
                    name: row[11],
                    imageUrl: (newImageUrl && newImageUrl.startsWith('http')) ? newImageUrl : oldImageUrl,
                    schedule: [row[28], row[29], row[30], row[31], row[32], row[33], row[34]]
                };
            }).filter(emp => emp.id && emp.name && emp.imageUrl);
            
            allEmployees = employees;
            populateEmployeeDropdown();

            const labeledDescriptorsPromises = employees
                .filter(emp => emp.imageUrl.startsWith('http'))
                .map(async employee => {
                    try {
                        const img = await faceapi.fetchImage(employee.imageUrl);
                        const detection = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                        if (detection) {
                            return new faceapi.LabeledFaceDescriptors(JSON.stringify(employee), [detection.descriptor]);
                        }
                        return null;
                    } catch (e) {
                        return null;
                    }
                });

            const settledDescriptors = await Promise.all(labeledDescriptorsPromises);
            return settledDescriptors.filter(descriptor => descriptor !== null);
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
                video.addEventListener('play', startFaceDetection);
            } catch (err) {
                 updateLoader('មិនអាចបើកកាមេរ៉ាបានទេ។');
            }
        }

        function startFaceDetection() {
            if (isDetectionRunning) return;
            isDetectionRunning = true;
            cameraContainer.classList.add('scanning');
            
            const detect = async () => {
                if (!isDetectionRunning) return;

                if (processing || !faceMatcher) {
                    if (isDetectionRunning) requestAnimationFrame(detect);
                    return;
                }
                
                const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
                const detection = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor();
                
                if (detection) {
                    const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                    if (bestMatch && bestMatch.label !== 'unknown') {
                        cameraContainer.classList.remove('scanning');
                        handleMatchFound(JSON.parse(bestMatch.label));
                    } else {
                        if (isDetectionRunning) requestAnimationFrame(detect);
                    }
                } else {
                    if (isDetectionRunning) requestAnimationFrame(detect);
                }
            };
            detect();
        }
        
        function stopFaceDetection() {
            isDetectionRunning = false;
            cameraContainer.classList.remove('scanning');
        }

        async function handleMatchFound(employee) {
            processing = true;
            const currentStatus = attendanceLog[employee.id];
            let action = !currentStatus ? 'check-in' : (currentStatus === 'checked-in' ? 'check-out' : 'done');
            if (action === 'done') {
                showResult(employee, 'បានកត់ត្រារួចរាល់សម្រាប់ថ្ងៃនេះ', 'slate');
                speak('សូមព្យាយាមម្ដងទៀត');
                setTimeout(() => resetState(), 5000);
                return;
            }
            const timeValidity = checkTimeValidity(employee.schedule, action);
            if (!timeValidity.isValid) {
                showResult(employee, timeValidity.message, 'red');
                speak('សូមព្យាយាមម្ដងទៀត');
                setTimeout(() => resetState(), 5000);
                return;
            }
            const isCheckIn = action === 'check-in';
            attendanceLog[employee.id] = isCheckIn ? 'checked-in' : 'checked-out';
            const message = isCheckIn ? 'Check In បានជោគជ័យ' : 'Check Out បានជោគជ័យ';
            const color = isCheckIn ? 'green' : 'amber';
            showResult(employee, message, color);
            speak(isCheckIn ? 'បាន ស្កេន ចូល ជោគជ័យ' : 'បាន ស្កេន ចេញ ជោគជ័យ');
            updateRecentScans(employee, action);
            await recordAttendance(employee.id, action, timeValidity.scheduleType);
            setTimeout(() => resetState(), 5000);
        }
        
        function showResult(employee, message, color) {
            const colors = { green: { bg: 'bg-green-100', text: 'text-green-700', border: 'border-green-500' }, amber: { bg: 'bg-amber-100', text: 'text-amber-700', border: 'border-amber-500' }, red: { bg: 'bg-red-100', text: 'text-red-700', border: 'border-red-500' }, slate: { bg: 'bg-slate-100', text: 'text-slate-700', border: 'border-slate-500' } };
            const theme = colors[color] || colors.slate;
            const imageUrl = employee.imageUrl || 'https://placehold.co/150x150';
            matchResultContainer.innerHTML = `<div class="fade-in flex flex-col items-center"> <img src="${imageUrl}" alt="រូបថតបុគ្គលិក" class="w-20 h-20 rounded-full object-cover border-4 ${theme.border} shadow-md -mt-10 mb-3"> <h3 class="text-xl font-bold text-slate-800">${employee.name}</h3> <p class="text-sm text-slate-500 mb-3">អត្តលេខ: ${employee.id}</p> <div class="px-4 py-2 rounded-lg ${theme.bg} ${theme.text} text-base font-semibold font-khmer">${message}</div> </div>`;
        }

        function updateRecentScans(employee, action) {
            if (noScansPlaceholder) { noScansPlaceholder.style.display = 'none'; }
            const timeStr = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            const imageUrl = employee.imageUrl || 'https://placehold.co/150x150';
            const newScan = { name: employee.name, action, time: timeStr, imageUrl: imageUrl, id: Date.now() };
            recentScans.unshift(newScan);
            if (recentScans.length > 8) recentScans.pop();
            const listHtml = recentScans.map(scan => {
                const isCheckIn = scan.action === 'check-in';
                const statusColor = isCheckIn ? 'text-green-600' : 'text-amber-600';
                const statusText = isCheckIn ? 'Check In' : 'Check Out';
                return `<li class="flex items-center py-3 fade-in"> <img src="${scan.imageUrl}" alt="${scan.name}" class="w-10 h-10 rounded-full object-cover mr-4"> <div class="flex-grow"> <p class="font-semibold text-slate-700">${scan.name}</p> <p class="text-xs text-slate-400">${scan.time}</p> </div> <span class="font-bold text-sm ${statusColor}">${statusText}</span> </li>`;
            }).join('');
            recentScansList.innerHTML = listHtml;
        }

        function resetState() {
            processing = false;
            matchResultContainer.innerHTML = '';
            startFaceDetection();
        }

        async function recordAttendance(empId, action, scheduleType) {
            if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('YOUR_GOOGLE')) return;
            try { await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', cache: 'no-cache', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ employeeId: empId, action: action, schedule: scheduleType }) }); } catch (error) { console.error('Error recording attendance:', error); }
        }

        function checkTimeValidity(scheduleArray, action) {
            const now = new Date(); const dayOfWeek = now.getDay(); const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes(); const scheduleToday = scheduleArray[dayOfWeek === 0 ? 6 : dayOfWeek - 1]; if (!scheduleToday || scheduleToday.trim() === '') return { isValid: false, message: 'មិនមានកាលវិភាគសម្រាប់ថ្ងៃនេះ' }; let validWindows = []; switch(scheduleToday) { case "ពេញម៉ោង": validWindows.push({ action: 'check-in', start: 7*60, end: 10*60+4 }); validWindows.push({ action: 'check-out', start: (dayOfWeek === 5 ? 15*60+15 : 17*60+30), end: 20*60+4 }); break; case "មួយព្រឹក": validWindows.push({ action: 'check-in', start: 7*60, end: 10*60+4 }); validWindows.push({ action: 'check-out', start: 11*60+30, end: 13*60+4 }); break; case "មួយរសៀល": validWindows.push({ action: 'check-in', start: 11*60, end: 13*60+44 }); validWindows.push({ action: 'check-out', start: (dayOfWeek === 5 ? 15*60+15 : 17*60+30), end: 20*60+4 }); break; case "ពេលយប់": validWindows.push({ action: 'check-in', start: 17*60+45, end: 19*60+44 }); validWindows.push({ action: 'check-out', start: 20*60+55, end: 22*60+4 }); break; } const targetWindow = validWindows.find(w => w.action === action); if (!targetWindow) return { isValid: false, message: `មិនអាច ${action} សម្រាប់កាលវិភាគ "${scheduleToday}"` }; if (currentTimeInMinutes >= targetWindow.start && currentTimeInMinutes <= targetWindow.end) { return { isValid: true, scheduleType: scheduleToday }; } const startTime = `${String(Math.floor(targetWindow.start / 60)).padStart(2, '0')}:${String(targetWindow.start % 60).padStart(2, '0')}`; const endTime = `${String(Math.floor(targetWindow.end / 60)).padStart(2, '0')}:${String(targetWindow.end % 60).padStart(2, '0')}`; return { isValid: false, message: `ក្រៅម៉ោង! ${action} ពី ${startTime} ដល់ ${endTime}` };
        }

        // --- Registration Logic ---
        function resetRegistrationModal() {
            videoRegister.classList.remove('hidden');
            capturedImagePreview.classList.add('hidden');
            captureBtn.classList.remove('hidden');
            retakeBtn.classList.add('hidden');
            saveBtn.classList.add('hidden');
            saveBtn.disabled = true;
            captureBtn.disabled = true;
            captureBtn.classList.add('disabled:bg-slate-300');
            registrationStatus.textContent = '';
            employeeSelectInput.value = '';
        }

        function populateEmployeeDropdown() {
            const optionsHtml = allEmployees.map(emp => `<option value="${emp.id} - ${emp.name}"></option>`).join('');
            employeeList.innerHTML = optionsHtml;
        }

        async function startRegistrationCamera() {
            try {
                registrationStream = await navigator.mediaDevices.getUserMedia({ video: {} });
                videoRegister.srcObject = registrationStream;
            } catch(err) {
                registrationStatus.textContent = 'មិនអាចបើកកាមេរ៉ាបានទេ';
                registrationStatus.classList.add('text-red-600');
            }
        }

        function stopRegistrationCamera() {
            if (registrationStream) {
                registrationStream.getTracks().forEach(track => track.stop());
                registrationStream = null;
            }
        }

        startRegistrationBtn.addEventListener('click', () => {
            stopFaceDetection();
            registrationOverlay.classList.remove('hidden');
            startRegistrationCamera();
        });

        cancelBtn.addEventListener('click', () => {
            if(mainContent.classList.contains('hidden')) {
                location.reload();
            } else {
                registrationOverlay.classList.add('hidden');
                stopRegistrationCamera();
                resetRegistrationModal();
                startFaceDetection();
            }
        });

        employeeSelectInput.addEventListener('input', () => {
            const selectedValue = employeeSelectInput.value;
            const isValidEmployee = allEmployees.some(emp => `${emp.id} - ${emp.name}` === selectedValue);
            
            if (isValidEmployee) {
                captureBtn.disabled = false;
                captureBtn.classList.remove('disabled:bg-slate-300');
                registrationStatus.textContent = '';
                registrationStatus.classList.remove('text-red-600');
            } else {
                captureBtn.disabled = true;
                captureBtn.classList.add('disabled:bg-slate-300');
            }
        });

        captureBtn.addEventListener('click', async () => {
            registrationStatus.textContent = 'កំពុងវិភាគគុណភាពរូប...';
            registrationStatus.classList.remove('text-red-600', 'text-green-600');
            
            const detection = await faceapi.detectSingleFace(videoRegister, new faceapi.TinyFaceDetectorOptions());
            if (!detection) {
                registrationStatus.textContent = 'រកមិនឃើញផ្ទៃមុខ។ សូមសាកល្បងម្តងទៀត។';
                registrationStatus.classList.add('text-red-600');
                return;
            }
            
            registrationStatus.textContent = 'រូបភាពល្អ! សូមពិនិត្យមើល រួចរក្សាទុក។';
            registrationStatus.classList.add('text-green-600');

            const context = canvasCapture.getContext('2d');
            canvasCapture.width = videoRegister.videoWidth;
            canvasCapture.height = videoRegister.videoHeight;
            context.drawImage(videoRegister, 0, 0, canvasCapture.width, canvasCapture.height);

            capturedImagePreview.src = canvasCapture.toDataURL('image/jpeg');
            videoRegister.classList.add('hidden');
            capturedImagePreview.classList.remove('hidden');
            
            captureBtn.classList.add('hidden');
            retakeBtn.classList.remove('hidden');
            saveBtn.classList.remove('hidden');
            saveBtn.disabled = false;
        });

        retakeBtn.addEventListener('click', () => {
            videoRegister.classList.remove('hidden');
            capturedImagePreview.classList.add('hidden');
            captureBtn.classList.remove('hidden');
            retakeBtn.classList.add('hidden');
            saveBtn.classList.add('hidden');
            saveBtn.disabled = true;
            registrationStatus.textContent = '';
        });

        saveBtn.addEventListener('click', async () => {
            const selectedValue = employeeSelectInput.value;
            if (!selectedValue) {
                registrationStatus.textContent = 'សូមជ្រើសរើសបុគ្គលិកជាមុនសិន។';
                registrationStatus.classList.add('text-red-600');
                return;
            }
            
            const employeeId = selectedValue.split(' - ')[0];
            const imageData = canvasCapture.toDataURL('image/jpeg');

            registrationStatus.textContent = 'កំពុងរក្សាទុក...';
            saveBtn.disabled = true;
            retakeBtn.disabled = true;
            cancelBtn.disabled = true;

            try {
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'update_photo', 
                        employeeId: employeeId, 
                        imageData: imageData 
                    })
                });

                registrationStatus.textContent = 'រក្សាទុកបានជោគជ័យ! ត្រៀមសម្រាប់អ្នកបន្ទាប់...';
                registrationStatus.classList.add('text-green-600');
                
                await loadSheetData();

                setTimeout(() => {
                    resetRegistrationModal();
                    cancelBtn.disabled = false;
                }, 2500);

            } catch (error) {
                console.error('Error saving photo:', error);
                registrationStatus.textContent = 'ការរក្សាទុកមានបញ្ហា។';
                registrationStatus.classList.add('text-red-600');
                saveBtn.disabled = false;
                retakeBtn.disabled = false;
                cancelBtn.disabled = false;
            }
        });

    </script>
</body>
</html>

