<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធគ្រប់គ្រងវត្តមានបុគ្គលិក</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            touch-action: manipulation;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #video-container, #verification-video-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: auto;
        }
        video {
            width: 100%;
            border-radius: 0.5rem;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        .combobox-options {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">
    <div id="main-container" class="w-full max-w-md mx-auto">
        
        <!-- Loading Screen -->
        <div id="loading-screen" class="text-center">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mx-auto mb-4"></div>
            <h2 class="text-xl font-semibold">កំពុងរៀបចំប្រព័ន្ធ...</h2>
            <p id="loading-message">សូមរង់ចាំបន្តិច</p>
        </div>

        <!-- Step 1: Verification -->
        <div id="verification-step" class="hidden bg-gray-800 p-6 rounded-lg shadow-lg">
            <h1 class="text-2xl font-bold text-center mb-2 text-teal-300">ផ្ទៀងផ្ទាត់អត្តសញ្ញាណ</h1>
            <p class="text-center text-gray-400 mb-6">សូមជ្រើសរើសឈ្មោះ និងផ្ទៀងផ្ទាត់ផ្ទៃមុខ</p>

            <!-- Custom Combobox -->
            <div id="combobox" class="relative">
                <input type="text" id="combobox-input" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="វាយអត្តលេខ ឬ ឈ្មោះ...">
                <div id="combobox-options" class="combobox-options hidden absolute z-10 w-full bg-gray-700 border border-gray-600 rounded-md mt-1">
                    <!-- Options will be populated by JS -->
                </div>
            </div>

            <div id="verification-video-container" class="mt-4 hidden">
                <video id="verification-video" playsinline autoplay muted></video>
            </div>
            <p id="verification-message" class="text-center mt-4 h-6"></p>
        </div>

        <!-- Step 2: Check In / Check Out -->
        <div id="check-in-out-step" class="hidden text-center bg-gray-800 p-6 rounded-lg shadow-lg">
             <div class="mb-4">
                <img id="employee-photo" class="w-24 h-24 rounded-full mx-auto border-4 border-teal-400" src="https://placehold.co/100x100/334155/e2e8f0?text=Employee" alt="Employee Photo">
                <h2 id="employee-name-display" class="text-xl font-bold mt-2"></h2>
                <p id="employee-id-display" class="text-gray-400"></p>
            </div>
            <p class="text-lg mb-4">ការផ្ទៀងផ្ទាត់ជោគជ័យ!</p>
            <div id="video-container" class="mb-4">
                <video id="qr-video" playsinline></video>
            </div>
            <p id="message" class="text-center mt-4 h-12"></p>
            <div id="attendance-log" class="mt-4 text-left bg-gray-700 p-4 rounded-lg max-h-48 overflow-y-auto">
                <h3 class="font-bold mb-2">កំណត់ត្រាវត្តមានថ្ងៃនេះ</h3>
                <div id="log-content"></div>
            </div>
        </div>
        
        <!-- Admin QR Code Generator -->
        <div id="admin-qr-generator" class="hidden mt-8 bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold text-center mb-4">QR Code សម្រាប់ទីតាំង</h2>
            <p class="text-center mb-4">សូមប្រើ QR Code នេះសម្រាប់ Check-in/out</p>
            <div id="qrcode" class="flex justify-center bg-white p-4 rounded-md"></div>
        </div>
    </div>
    
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

    <script>
        const verificationVideo = document.getElementById('verification-video');
        const qrVideo = document.getElementById('qr-video');
        const messageDiv = document.getElementById('message');
        const verificationMessageDiv = document.getElementById('verification-message');
        const loadingScreen = document.getElementById('loading-screen');
        const loadingMessage = document.getElementById('loading-message');
        const verificationStep = document.getElementById('verification-step');
        const checkInOutStep = document.getElementById('check-in-out-step');
        const adminQrGenerator = document.getElementById('admin-qr-generator');
        const verificationVideoContainer = document.getElementById('verification-video-container');
        const logContent = document.getElementById('log-content');
        
        // Combobox elements
        const comboboxInput = document.getElementById('combobox-input');
        const comboboxOptions = document.getElementById('combobox-options');

        let employees = [];
        let selectedEmployee = null;
        let currentStream;
        let qrScanner;

        const GOOGLE_SHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
        const GOOGLE_SHEET_NAME = 'DIList';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxVk-h1hW8g-_Z-rViFVzzRN8h1b9fNjoleNjj1gaHd42X3C66vVJi1HJARXYTB81rG/exec';

        // --- Data Fetching ---
        async function fetchEmployeeData() {
            loadingMessage.textContent = 'កំពុងទាញទិន្នន័យបុគ្គលិក...';
            try {
                const url = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${GOOGLE_SHEET_NAME}&headers=1`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const csvText = await response.text();
                
                const rows = csvText.split('\n').map(row => row.split('","').map(cell => cell.replace(/"/g, '')));
                employees = rows.slice(8) 
                    .map(row => ({
                        id: row[4],       // Column E
                        name: row[11],    // Column L
                        photoUrl: row[26] // Column AA
                    }))
                    .filter(emp => emp.id && emp.name && emp.photoUrl); // Ensure all data is present
                
                populateCombobox(employees);
            } catch (error) {
                console.error('Error fetching employee data:', error);
                loadingMessage.textContent = 'បរាជ័យក្នុងការទាញទិន្នន័យបុគ្គលិក។';
            }
        }

        // --- Combobox Logic ---
        function populateCombobox(data) {
            comboboxOptions.innerHTML = '';
            data.forEach(emp => {
                const option = document.createElement('div');
                option.className = 'p-2 hover:bg-gray-600 cursor-pointer';
                option.textContent = `${emp.id} - ${emp.name}`;
                option.dataset.id = emp.id;
                option.addEventListener('click', () => {
                    comboboxInput.value = option.textContent;
                    comboboxOptions.classList.add('hidden');
                    handleEmployeeSelection(emp.id);
                });
                comboboxOptions.appendChild(option);
            });
        }

        comboboxInput.addEventListener('focus', () => comboboxOptions.classList.remove('hidden'));
        comboboxInput.addEventListener('blur', () => setTimeout(() => comboboxOptions.classList.add('hidden'), 200));

        comboboxInput.addEventListener('input', () => {
            const filter = comboboxInput.value.toLowerCase();
            const filteredEmployees = employees.filter(emp => 
                emp.name.toLowerCase().includes(filter) || emp.id.toLowerCase().includes(filter)
            );
            populateCombobox(filteredEmployees);
            comboboxOptions.classList.remove('hidden');
        });

        // --- Face Verification Logic ---
        async function handleEmployeeSelection(employeeId) {
            selectedEmployee = employees.find(emp => emp.id === employeeId);
            if (!selectedEmployee) return;

            verificationMessageDiv.textContent = 'កំពុងរៀបចំកាមេរ៉ា...';
            verificationVideoContainer.classList.remove('hidden');

            try {
                // IMPORTANT: The image URL must be publicly accessible and allow cross-origin requests (CORS).
                const referenceImage = await faceapi.fetchImage(selectedEmployee.photoUrl);
                const referenceDescriptor = await faceapi.detectSingleFace(referenceImage, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();

                if (!referenceDescriptor) {
                    verificationMessageDiv.textContent = 'មិនអាចស្វែងរកមុខក្នុងរូបថតយោងបានទេ។';
                    return;
                }

                startVerificationCamera(referenceDescriptor);
            } catch (error) {
                console.error("Error processing reference image:", error);
                verificationMessageDiv.textContent = 'URL រូបថតមិនត្រឹមត្រូវ ឬមានបញ្ហា CORS។';
            }
        }
        
        async function startVerificationCamera(referenceDescriptor) {
            stopAllStreams();
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                verificationVideo.srcObject = currentStream;
                verificationMessageDiv.textContent = 'សូមដាក់មុខឲ្យចំកាមេរ៉ា';

                const intervalId = setInterval(async () => {
                    if(!currentStream) { // Stop if stream was cancelled
                        clearInterval(intervalId);
                        return;
                    }
                    const detections = await faceapi.detectSingleFace(verificationVideo, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    if (detections) {
                        const faceMatcher = new faceapi.FaceMatcher(referenceDescriptor);
                        const bestMatch = faceMatcher.findBestMatch(detections.descriptor);

                        if (bestMatch.label !== 'unknown') {
                            verificationMessageDiv.textContent = 'ផ្ទៀងផ្ទាត់ជោគជ័យ!';
                            clearInterval(intervalId);
                            stopAllStreams();
                            verificationStep.classList.add('hidden');
                            displayCheckInOutStep();
                        } else {
                            verificationMessageDiv.textContent = 'មុខមិនត្រូវគ្នា សូមព្យាយាមម្តងទៀត';
                        }
                    }
                }, 1000);
            } catch (err) {
                verificationMessageDiv.textContent = 'មិនអាចបើកកាមេរ៉ាបានទេ។ សូមអនុញ្ញាតឱ្យ Browser ប្រើប្រាស់កាមេរ៉ា។';
                console.error("Camera access error:", err);
            }
        }
        
        // --- QR & Geolocation Logic ---
        function displayCheckInOutStep() {
            document.getElementById('employee-photo').src = selectedEmployee.photoUrl;
            document.getElementById('employee-name-display').textContent = selectedEmployee.name;
            document.getElementById('employee-id-display').textContent = `ID: ${selectedEmployee.id}`;
            updateLogDisplay();
            checkInOutStep.classList.remove('hidden');
            startQRScanner();
        }

        async function startQRScanner() {
            messageDiv.textContent = 'កំពុងបើកកាមេរ៉ាដើម្បីស្កេន QR Code...';
            messageDiv.className = 'text-center mt-4 h-12 text-yellow-400';
            stopAllStreams();
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } });
                qrVideo.srcObject = currentStream;
                qrVideo.play();
                messageDiv.textContent = 'សូមស្កេន QR Code របស់ទីតាំង';
                messageDiv.className = 'text-center mt-4 h-12 text-white';
                qrScanner = requestAnimationFrame(tick);
            } catch (err) {
                 messageDiv.textContent = 'បរាជ័យក្នុងការបើកកាមេរ៉ាក្រោយ។';
                 messageDiv.className = 'text-center mt-4 h-12 text-red-500';
                 console.error("Rear camera error:", err);
            }
        }

        function tick() {
            if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
                const canvasElement = document.createElement('canvas');
                const canvas = canvasElement.getContext('2d');
                canvasElement.height = qrVideo.videoHeight;
                canvasElement.width = qrVideo.videoWidth;
                canvas.drawImage(qrVideo, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    handleQRCode(code.data);
                    return; // Stop this animation frame, handleQRCode will restart if necessary.
                }
            }
            qrScanner = requestAnimationFrame(tick);
        }

        function handleQRCode(qrData) {
            messageDiv.textContent = 'បានស្កេន QR Code! កំពុងពិនិត្យទីតាំង...';
            messageDiv.className = 'text-center mt-4 h-12 text-yellow-400';
            
            try {
                const allowedAreaCoords = JSON.parse(qrData);
                if (!Array.isArray(allowedAreaCoords)) throw new Error("Invalid QR data format");

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userCoords = [position.coords.latitude, position.coords.longitude];
                        if (isPointInPolygon(userCoords, allowedAreaCoords)) {
                            // SUCCESS!
                            cancelAnimationFrame(qrScanner);
                            stopAllStreams();
                            submitAttendance();
                        } else {
                            // FAILURE: Wrong location
                            messageDiv.textContent = 'អ្នកមិនស្ថិតនៅក្នុងទីតាំងដែលបានអនុញ្ញាតទេ។';
                            messageDiv.className = 'text-center mt-4 h-12 text-red-500';
                            setTimeout(() => {
                                messageDiv.textContent = 'សូមស្កេន QR Code របស់ទីតាំង';
                                messageDiv.className = 'text-center mt-4 h-12 text-white';
                                qrScanner = requestAnimationFrame(tick);
                            }, 2500);
                        }
                    },
                    (error) => {
                        messageDiv.textContent = 'មិនអាចទទួលបានទីតាំង GPS។';
                        messageDiv.className = 'text-center mt-4 h-12 text-red-500';
                        setTimeout(() => {
                            messageDiv.textContent = 'សូមស្កេន QR Code របស់ទីតាំង';
                            messageDiv.className = 'text-center mt-4 h-12 text-white';
                            qrScanner = requestAnimationFrame(tick);
                        }, 2500);
                    },
                    { enableHighAccuracy: true }
                );
            } catch (e) {
                // FAILURE: Invalid QR Code format
                messageDiv.textContent = 'QR Code មិនត្រឹមត្រូវទេ។';
                messageDiv.className = 'text-center mt-4 h-12 text-red-500';
                setTimeout(() => {
                    messageDiv.textContent = 'សូមស្កេន QR Code របស់ទីតាំង';
                    messageDiv.className = 'text-center mt-4 h-12 text-white';
                    qrScanner = requestAnimationFrame(tick);
                }, 2500);
            }
        }
        
        // --- Data Submission ---
        function submitAttendance() {
            const lastLog = getTodaysLog().pop();
            const action = (!lastLog || lastLog.action === 'Check Out') ? 'Check In' : 'Check Out';

            messageDiv.textContent = `កំពុងបញ្ជូន ${action}...`;
            messageDiv.className = 'text-center mt-4 h-12 text-yellow-400';

            navigator.geolocation.getCurrentPosition(position => {
                const data = {
                    timestamp: new Date().toISOString(),
                    employeeId: selectedEmployee.id,
                    employeeName: selectedEmployee.name,
                    action: action,
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    userAgent: navigator.userAgent
                };

                fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        messageDiv.textContent = `${action} បានកត់ត្រាដោយជោគជ័យ!`;
                        messageDiv.className = 'text-center mt-4 h-12 text-green-500';
                        saveLog(action);
                        updateLogDisplay();
                    } else {
                        // Display the specific error message from the Apps Script
                        messageDiv.textContent = result.message || 'An unknown error occurred.';
                        messageDiv.className = 'text-center mt-4 h-12 text-red-500';
                    }
                })
                .catch(error => {
                    console.error('Error submitting attendance:', error);
                    messageDiv.textContent = `មានបញ្ហាក្នុងការបញ្ជូនទិន្នន័យ។`;
                    messageDiv.className = 'text-center mt-4 h-12 text-red-500';
                });
            });
        }
        
        // --- Local Log for UI ---
        function saveLog(action) {
            const logs = JSON.parse(localStorage.getItem('attendanceLogs') || '{}');
            const today = new Date().toISOString().slice(0, 10);
            if (!logs[selectedEmployee.id]) logs[selectedEmployee.id] = {};
            if (!logs[selectedEmployee.id][today]) logs[selectedEmployee.id][today] = [];

            const time = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit'});
            logs[selectedEmployee.id][today].push({ action, time });
            localStorage.setItem('attendanceLogs', JSON.stringify(logs));
        }

        function getTodaysLog() {
            if (!selectedEmployee) return [];
            const logs = JSON.parse(localStorage.getItem('attendanceLogs') || '{}');
            const today = new Date().toISOString().slice(0, 10);
            return (logs[selectedEmployee.id] && logs[selectedEmployee.id][today]) ? logs[selectedEmployee.id][today] : [];
        }

        function updateLogDisplay() {
            const todaysLog = getTodaysLog();
            if (todaysLog.length === 0) {
                logContent.innerHTML = '<p class="text-gray-400">មិនទាន់មានកំណត់ត្រាសម្រាប់ថ្ងៃនេះ</p>';
            } else {
                logContent.innerHTML = todaysLog.map(log => `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold ${log.action === 'Check In' ? 'text-green-400' : 'text-orange-400'}">${log.action}</span>
                        <span>${log.time}</span>
                    </div>
                `).join('');
            }
        }

        // --- Utility Functions ---
        function isPointInPolygon(point, polygon) {
            let x = point[0], y = point[1];
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                let xi = polygon[i][0], yi = polygon[i][1];
                let xj = polygon[j][0], yj = polygon[j][1];
                let intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }
        
        function stopAllStreams() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            if (qrScanner) {
                cancelAnimationFrame(qrScanner);
                qrScanner = null;
            }
        }

        // --- Initialization ---
        async function initialize() {
            // Check for insecure context which can block camera access
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                loadingScreen.innerHTML = `
                    <div class="bg-red-900 border border-red-600 p-6 rounded-lg">
                        <h2 class="text-xl font-semibold text-red-300">បញ្ហាសុវត្ថិភាព</h2>
                        <p class="mt-2 text-red-200">កម្មវិធីនេះត្រូវតែដំណើរការលើ HTTPS ឬ localhost ដើម្បីអាចប្រើប្រាស់កាមេរ៉ាបាន។</p>
                    </div>
                `;
                return;
            }

            loadingMessage.textContent = 'កំពុងរៀបចំប្រព័ន្ធសម្គាល់ផ្ទៃមុខ...';
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/weights/';
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
            } catch (error) {
                 loadingMessage.textContent = 'បរាជ័យក្នុងការផ្ទុក Model សម្គាល់មុខ។';
                 console.error("Model loading error:", error);
                 return;
            }
            
            await fetchEmployeeData();
            
            loadingScreen.classList.add('hidden');
            verificationStep.classList.remove('hidden');

            // Admin check and QR Code Generation
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('role') === 'admin') {
                adminQrGenerator.classList.remove('hidden');
                const allowedAreaCoords = [
                    [11.415044506197871, 104.76410481548675],
                    [11.415078950407759, 104.76400720634004],
                    [11.413697351586457, 104.76333370321305],
                    [11.413659080055572, 104.76343912109148]
                ];
                 new QRCode(document.getElementById("qrcode"), {
                    text: JSON.stringify(allowedAreaCoords),
                    width: 200,
                    height: 200,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
            }
        }

        initialize();
    </script>
</body>
</html>

