<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីសម្គាល់អត្តសញ្ញាណ</title>
    <!-- Tailwind CSS សម្រាប់រចនាទំព័រ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- face-api.js សម្រាប់វិភាគមុខ -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- Google Fonts សម្រាប់ហ្វុងខ្មែរ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: #f0f2f5;
        }
        .loader {
            border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        .spinner {
            border: 2px solid #f3f3f3; border-radius: 50%; border-top: 2px solid #9ca3af;
            width: 16px; height: 16px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #cameraModal { background-color: rgba(0, 0, 0, 0.6); }
        #videoContainer {
            width: 100%; height: 100%; border-radius: 50%; overflow: hidden; position: relative;
            background-color: #000; transform: scaleX(-1);
        }
        #video, #overlay {
            position: absolute; top: 50%; left: 50%; min-width: 100%; min-height: 100%;
            width: auto; height: auto; transform: translate(-50%, -50%);
        }
        #scannerEffect {
            --scanner-color: #3b82f6; position: absolute; inset: 0; border-radius: 50%;
            background: conic-gradient(from 180deg at 50% 50%, rgba(59, 130, 246, 0) 0%, var(--scanner-color) 50%, rgba(59, 130, 246, 0) 100%);
            animation: scanner-spin 2s linear infinite;
        }
        @keyframes scanner-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #laserScanner { position: absolute; inset: 0.5rem; border-radius: 50%; overflow: hidden; pointer-events: none; z-index: 2; }
        #laserScanner::after {
            content: ''; position: absolute; top: 0; width: 3px; height: 100%; background: #3b82f6;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.8), 0 0 10px rgba(59, 130, 246, 0.8), 0 0 15px rgba(255, 255, 255, 0.8);
            animation: laser-scan-line 2.5s ease-in-out infinite;
        }
        @keyframes laser-scan-line { 0% { left: 15%; } 50% { left: 85%; } 100% { left: 15%; } }
        
        .attendance-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 0.5rem; padding: 1.5rem 1rem; border-radius: 1rem; font-weight: 700;
            transition: all 0.2s ease-in-out; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid transparent;
        }
        .attendance-btn:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 7px 14px rgba(0,0,0,0.07);
        }
        .attendance-btn:disabled {
            background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; opacity: 0.7;
        }

        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

        #countdownCircle { transition: stroke-dashoffset 0.5s linear; }
    </style>
</head>
<body class="flex justify-center min-h-screen p-4 sm:items-center">

    <!-- ទម្រង់ចូល -->
    <div id="appContainer" class="w-full max-w-md bg-white rounded-lg shadow-xl p-8 space-y-6 hidden">
        <div class="text-center">
            <h1 class="text-2xl font-bold text-gray-800">ទម្រង់ចូលគណនី</h1>
            <p class="text-gray-500 mt-2">សូមជ្រើសរើសព័ត៌មានរបស់អ្នក</p>
        </div>
        <form id="accountForm" class="space-y-6">
            <div>
                <label for="classInput" class="block text-sm font-medium text-gray-700 mb-1">ជ្រើសរើសថ្នាក់រៀន</label>
                <input list="classList" id="classInput" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                <datalist id="classList"></datalist>
            </div>
            <div>
                <label for="idInput" class="block text-sm font-medium text-gray-700 mb-1">ជ្រើសរើសអត្តលេខ</label>
                <input list="idList" id="idInput" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off" disabled>
                <datalist id="idList"></datalist>
            </div>
            <div class="bg-gray-50 p-4 rounded-md text-center">
                <label class="text-sm font-medium text-gray-500">ឈ្មោះសិស្ស</label>
                <p id="nameDisplay" class="text-xl font-bold text-indigo-600 mt-1">-</p>
            </div>
        </form>
         <div id="errorContainer" class="text-center hidden">
             <p id="errorMessage" class="text-red-500"></p>
             <button id="retryButton" class="mt-4 w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600">ព្យាយាមម្ដងទៀត</button>
         </div>
    </div>
    
    <!-- Loader -->
    <div id="loader" class="flex flex-col items-center justify-center space-y-2">
        <div class="loader"></div>
        <p class="text-gray-500">កំពុងរៀបចំ...</p>
    </div>

    <!-- ផ្ទាំងវត្តមាន -->
    <div id="attendancePage" class="hidden w-full max-w-md sm:max-w-lg">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 space-y-6">
            <div class="flex flex-col items-center space-y-2">
                <div class="w-20 h-20 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-3xl font-bold ring-4 ring-white shadow-md">
                    <span id="userInitial"></span>
                </div>
                <p class="text-gray-600 text-lg pt-2">សូមស្វាគមន៍</p>
                <h1 class="text-2xl font-bold text-gray-800" id="attendanceName"></h1>
            </div>
            <div id="statusContainer" class="bg-gray-100 p-4 rounded-lg min-h-[50px] flex items-center justify-center">
                <p id="statusMessage" class="text-gray-700 font-medium text-center"></p>
            </div>
            <div class="grid grid-cols-2 gap-4 pt-2">
                <button id="checkInButton" class="attendance-btn bg-green-50 border-green-200 text-green-700">
                    <div id="checkInContent">
                        <svg class="w-10 h-10 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" /></svg>
                        <span class="text-lg mt-2">Check In</span>
                    </div>
                </button>
                <button id="checkOutButton" class="attendance-btn bg-red-50 border-red-200 text-red-700">
                     <div id="checkOutContent">
                        <svg class="w-10 h-10 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m-3 0l-3-3m0 0l3-3m-3 3H9" /></svg>
                        <span class="text-lg mt-2">Check Out</span>
                    </div>
                </button>
            </div>
        </div>
        <div class="text-center mt-6">
            <button id="logoutButton" class="text-gray-500 hover:text-red-500 font-medium transition-colors flex items-center justify-center mx-auto gap-2">
                 <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                <span>ចាកចេញ</span>
            </button>
        </div>
    </div>

    <!-- Modal ផ្ទៀងផ្ទាត់កាមេរ៉ា -->
    <div id="cameraModal" class="fixed inset-0 w-full h-full flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center">
            <h2 class="text-xl font-bold mb-4">សូមដាក់មុខនៅចំកណ្តាល</h2>
            <div class="relative w-64 h-64 mx-auto mb-4 p-2">
                <div id="scannerEffect"></div><div id="laserScanner"></div>
                <div id="videoContainer">
                    <video id="video" autoplay muted playsinline></video><canvas id="overlay"></canvas>
                </div>
            </div>
            <p id="cameraStatus" class="text-gray-600 mb-4 h-6">កំពុងចាប់ផ្តើមកាមេរ៉ា...</p>
            <button id="closeModalButton" class="bg-red-500 text-white font-bold py-2 px-6 rounded-md hover:bg-red-600">បោះបង់</button>
        </div>
    </div>
    
    <!-- សារព្រមាន -->
    <div id="liveTrackingWarning" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 p-8 text-center">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm">
            <h3 class="text-lg font-bold text-red-600 mb-2">!!! ការព្រមាន !!!</h3>
            <p class="text-gray-800 font-semibold">"ប្អូនបាន Check in ជោគជ័យហើយ ប៉ុន្តែក្នុងករណីប្អូនបិទ Location ឬ បិទ WIFI (Internet) ឬប្អូនបានឈានជើងចាកចេញពីអគារ DI ក្នុងម៉ោងធ្វើការរយៈពេល ១៤វិនាទីគឺស្មើនិងអវត្តមានដោយស្វ័យប្រវត្តិ"</p>
        </div>
    </div>
    
    <!-- Countdown Timer Modal -->
    <div id="countdownModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-xs w-full text-center transform transition-all scale-95 opacity-0" id="countdownModalContent">
            <h3 class="text-lg font-bold text-gray-800 mb-4">ពេលវេលារហូតដល់ម៉ោង Check Out</h3>
            <div class="relative w-48 h-48 mx-auto">
                <svg class="w-full h-full" viewBox="0 0 100 100">
                    <circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    <circle id="countdownCircle" class="text-indigo-500" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" 
                            style="transform: rotate(-90deg); transform-origin: 50% 50%;" />
                </svg>
                <div id="countdownText" class="absolute inset-0 flex flex-col items-center justify-center text-2xl font-bold text-indigo-600">
                    <span id="countdownHours">00</span>:<span id="countdownMinutes">00</span>:<span id="countdownSeconds">00</span>
                </div>
            </div>
             <p class="text-sm text-gray-500 mt-4">ការតាមដានទីតាំងកំពុងដំណើរការ</p>
        </div>
    </div>
    
    <!-- Modal បញ្ជាក់ការចាកចេញ -->
    <div id="logoutModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center transform transition-all scale-95 opacity-0" id="logoutModalContent">
            <h3 class="text-lg font-bold text-gray-800 mb-4">បញ្ជាក់ការចាកចេញ</h3>
            <p class="text-gray-600 mb-6">តើអ្នកពិតជាចង់ចាកចេញមែនទេ?</p>
            <div class="flex justify-center gap-4">
                <button id="cancelLogoutButton" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">បោះបង់</button>
                <button id="confirmLogoutButton" class="px-6 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">យល់ព្រម</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- ការកំណត់ค่า Configuration ---
            const SHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
            const SHEET_NAME = 'DIList';
            const RANGE = 'E9:AI';
            const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}&range=${RANGE}`;
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            
            const LEAVE_SHEET_ID = '18oonwPyyU6I0hHX-vucvoYSqGf_S7wPnQX817CqauPE';
            const LEAVE_SHEET_NAME = 'Requests';
            const CRB_LEAVE_SHEET_ID = '1xpy1CDg3LTD1iYPXKbfJrjldR5vVW3AhoNSwTzb8wDY';
            const CRB_LEAVE_SHEET_NAME = 'CRBRequests';
            
            const allowedAreaCoords = [
                [11.415296921108219, 104.76411630326837],
                [11.41524959639537, 104.76421353334031],
                [11.4136513648048, 104.76344030651754],
                [11.413703948114726, 104.76333502981896]
            ];

            // !!! សំខាន់ !!! សូមបង្កើត Google Apps Script ហើយបិទភ្ជាប់ Web App URL របស់អ្នកនៅទីនេះ
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzx1R73GM37Ys4VdETHSPrJGnc-h9_upi676KBXZnM_-slZvPjM3UCH7y6PHEXMZIlVHw/exec';

            // --- DOM Elements ---
            const loader = document.getElementById('loader');
            const appContainer = document.getElementById('appContainer');
            const accountForm = document.getElementById('accountForm');
            const classInput = document.getElementById('classInput');
            const idInput = document.getElementById('idInput');
            const nameDisplay = document.getElementById('nameDisplay');
            const classDatalist = document.getElementById('classList');
            const idDatalist = document.getElementById('idList');
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            const retryButton = document.getElementById('retryButton');
            const cameraModal = document.getElementById('cameraModal');
            const video = document.getElementById('video');
            const overlay = document.getElementById('overlay');
            const cameraStatus = document.getElementById('cameraStatus');
            const closeModalButton = document.getElementById('closeModalButton');
            const attendancePage = document.getElementById('attendancePage');
            const attendanceName = document.getElementById('attendanceName');
            const userInitial = document.getElementById('userInitial');
            const statusMessage = document.getElementById('statusMessage');
            const checkInButton = document.getElementById('checkInButton');
            const checkOutButton = document.getElementById('checkOutButton');
            const checkInContent = document.getElementById('checkInContent');
            const checkOutContent = document.getElementById('checkOutContent');
            const logoutButton = document.getElementById('logoutButton');
            const liveTrackingWarning = document.getElementById('liveTrackingWarning');
            const logoutModal = document.getElementById('logoutModal');
            const logoutModalContent = document.getElementById('logoutModalContent');
            const cancelLogoutButton = document.getElementById('cancelLogoutButton');
            const confirmLogoutButton = document.getElementById('confirmLogoutButton');
            const countdownModal = document.getElementById('countdownModal');
            const countdownModalContent = document.getElementById('countdownModalContent');
            const countdownCircle = document.getElementById('countdownCircle');
            const countdownHours = document.getElementById('countdownHours');
            const countdownMinutes = document.getElementById('countdownMinutes');
            const countdownSeconds = document.getElementById('countdownSeconds');
            const circleRadius = countdownCircle.r.baseVal.value;
            const circumference = 2 * Math.PI * circleRadius;
            countdownCircle.style.strokeDasharray = circumference;

            // --- State Management ---
            let studentData = []; let currentStudent = null; let faceMatcher = null;
            let areModelsLoaded = false; let isVerifying = false; 
            let liveWatchId = null; let disconnectionTimer = null; let isCurrentlyTracking = false;
            let telegramAlertSent = false;
            let disconnectionLogged = false;
            let countdownInterval = null;

            // --- Core Functions ---
            async function checkForSavedSession() {
                const savedStudentJSON = localStorage.getItem('loggedInStudent');
                if (savedStudentJSON) {
                    loader.classList.remove('hidden');
                    loader.querySelector('p').textContent = 'កំពុងធ្វើបច្ចុប្បន្នភាព...';
                    try {
                        await Promise.all([loadModels(), fetchData()]);
                        const studentFromLocal = JSON.parse(savedStudentJSON);
                        const fullStudentObject = studentData.find(s => s.id === studentFromLocal.id);
                        if (fullStudentObject) {
                            await showAttendancePage(fullStudentObject);
                        } else { logout(); }
                    } catch (e) { console.error("Session restore failed:", e); logout(); }
                } else { initializeLoginForm(); }
            }
            
            async function initializeLoginForm() {
                loader.classList.remove('hidden');
                loader.querySelector('p').textContent = 'កំពុងទាញទិន្នន័យ...';
                try {
                    await Promise.all([loadModels(), fetchData()]);
                    appContainer.classList.remove('hidden');
                    appContainer.classList.add('fade-in-up');
                } catch(e) {
                    showError('មិនអាចទាញទិន្នន័យបានទេ។ សូមព្យាយាមម្តងទៀត។')
                }
            }

            async function showAttendancePage(student) {
                loader.classList.add('hidden');
                appContainer.classList.add('hidden');
                errorContainer.classList.add('hidden');
                currentStudent = student;
                attendanceName.textContent = student.name;
                if (student.name) {
                    userInitial.textContent = student.name.trim().charAt(0).toUpperCase();
                }
                attendancePage.classList.remove('hidden');
                attendancePage.classList.add('fade-in-up');
                await updateButtonStates();
            }
            
            function logout() {
                stopLiveTracking();
                localStorage.removeItem('loggedInStudent');
                attendancePage.classList.add('hidden');
                accountForm.reset();
                idInput.disabled = true;
                idDatalist.innerHTML = '';
                nameDisplay.textContent = '-';
                appContainer.classList.remove('hidden');
                currentStudent = null;
            }

            async function loadModels() {
                if (areModelsLoaded) return;
                try {
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                        faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL),
                        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                    ]);
                    areModelsLoaded = true;
                } catch (error) { 
                    console.error("Model loading error:", error);
                    throw new Error('បរាជ័យក្នុងការទាញយកម៉ូដែលវិភាគមុខ។'); 
                }
            }
            
            async function fetchData() {
                try {
                    const response = await fetch(`${URL}&t=${new Date().getTime()}`);
                    if (!response.ok) throw new Error(`Network error: ${response.status}`);
                    const text = await response.text();
                    const jsonString = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
                    const data = JSON.parse(jsonString);
                    if (data.status === 'error') throw new Error(data.errors.map(e => e.detailed_message).join(', '));
                    studentData = data.table.rows.map(row => {
                        if (!row || !row.c) return null;
                        const [id, name, className, imageUrl] = [row.c[0]?.v, row.c[7]?.v, row.c[13]?.v, row.c[22]?.v];
                        if (id && name && className && imageUrl) {
                            const finalImageUrl = imageUrl.includes('drive.google.com')
                                ? `https://images.weserv.nl/?url=${encodeURIComponent(imageUrl.replace('/file/d/', '/uc?export=view&id='))}`
                                : imageUrl;
                            const schedule = {
                                mon: row.c[24]?.v, tue: row.c[25]?.v, wed: row.c[26]?.v,
                                thu: row.c[27]?.v, fri: row.c[28]?.v, sat: row.c[29]?.v, sun: row.c[30]?.v,
                            };
                            return { id: String(id), name: String(name), class: String(className), imageUrl: finalImageUrl, schedule };
                        }
                        return null;
                    }).filter(Boolean);
                    populateClasses();
                } catch (error) { 
                    console.error("Fetch data error:", error);
                    throw new Error('បរាជ័យក្នុងការទាញទិន្នន័យ។');
                }
            }
            
            function handleRetry() {
                errorContainer.classList.add('hidden');
                appContainer.classList.add('hidden');
                loader.classList.remove('hidden');
                initializeLoginForm();
            }

            function populateClasses() {
                const uniqueClasses = [...new Set(studentData.map(item => item.class))];
                classDatalist.innerHTML = '';
                uniqueClasses.sort().forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    classDatalist.appendChild(option);
                });
            }

            function handleClassChange() {
                idDatalist.innerHTML = ''; idInput.value = ''; nameDisplay.textContent = '-';
                currentStudent = null;
                const filteredData = studentData.filter(item => item.class === classInput.value);
                idInput.disabled = filteredData.length === 0;
                filteredData.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    idDatalist.appendChild(option);
                });
            }

            async function handleIdChange() {
                if (isVerifying) return;
                currentStudent = studentData.find(item => item.id === idInput.value);
                if (currentStudent) {
                    nameDisplay.textContent = currentStudent.name;
                    await startVerification();
                } else { nameDisplay.textContent = '-'; }
            }

            function showError(message) {
                loader.classList.add('hidden');
                appContainer.classList.add('hidden');
                attendancePage.classList.add('hidden');
                errorMessage.textContent = message;
                errorContainer.classList.remove('hidden');
            }

            function stopCameraStream() {
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }
                video.removeEventListener('play', onVideoPlay);
            }

            async function startVerification() {
                if (!currentStudent || !areModelsLoaded) return;
                isVerifying = true; 
                cameraModal.classList.remove('hidden');
                cameraStatus.textContent = 'កំពុងរៀបចំ...';
                try {
                    const detectionOptions = new faceapi.TinyFaceDetectorOptions({ inputSize: 224 });
                    cameraStatus.textContent = 'កំពុងដំណើរការរូបថតយោង...';
                    const referenceImage = await faceapi.fetchImage(currentStudent.imageUrl);
                    const referenceDetection = await faceapi.detectSingleFace(referenceImage, detectionOptions).withFaceLandmarks(true).withFaceDescriptor();
                    if (!referenceDetection) throw new Error("Face not found in reference image.");
                    faceMatcher = new faceapi.FaceMatcher([referenceDetection.descriptor]);
                    cameraStatus.textContent = 'កំពុងស្នើសុំកាមេរ៉ា...';
                    video.srcObject = await navigator.mediaDevices.getUserMedia({ video: {} });
                    video.addEventListener('play', onVideoPlay);
                } catch (error) {
                    let userMessage = 'មានបញ្ហាក្នុងការបើកកាមេរ៉ា។';
                    if (error.name === 'NotAllowedError') userMessage = 'មិនមានការអនុញ្ញាតឱ្យប្រើកាមេរ៉ាទេ។';
                    else if (error.message.includes("Face not found")) userMessage = "បញ្ហារូបថត៖ រកមិនឃើញមុខក្នុងរូបថតដើម។";
                    cameraStatus.textContent = userMessage;
                    setTimeout(() => closeVerificationModal(true), 4000);
                }
            }

            async function onVideoPlay() {
                if (!isVerifying) return;
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 224 })).withFaceLandmarks(true).withFaceDescriptors();
                if (detections.length > 0) {
                    const bestMatch = faceMatcher.findBestMatch(detections[0].descriptor);
                    const confidence = ((1 - bestMatch.distance) * 100).toFixed(0);
                    cameraStatus.textContent = `កំពុងផ្ទៀងផ្ទាត់... (${confidence}%)`;
                    if (bestMatch.label !== 'unknown' && bestMatch.distance < 0.5) { 
                        verificationSuccess(); return;
                    }
                } else {
                    cameraStatus.textContent = 'រកមិនឃើញមុខ';
                }
                requestAnimationFrame(onVideoPlay);
            }

            function verificationSuccess() {
                isVerifying = false;
                cameraStatus.textContent = 'ជោគជ័យ!';
                localStorage.setItem('loggedInStudent', JSON.stringify(currentStudent));
                setTimeout(() => {
                  closeVerificationModal(false);
                  showAttendancePage(currentStudent);
                }, 1000);
            }

            function closeVerificationModal(resetInputs = true) {
                isVerifying = false; stopCameraStream();
                cameraModal.classList.add('hidden');
                if (resetInputs && idInput.value) {
                    idInput.value = ''; nameDisplay.textContent = '-'; currentStudent = null;
                }
            }

            async function fetchLeaveDataFromSheet(sheetId, sheetName, studentId) {
                try {
                    const response = await fetch(`${`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`}&t=${new Date().getTime()}`);
                    if (!response.ok) { throw new Error(`Network error for sheet ${sheetName}: ${response.statusText}`); }
                    const text = await response.text();
                     if (!text || !text.includes('google.visualization.Query.setResponse')) {
                         throw new Error(`Invalid response from Google Sheet '${sheetName}'. Check sharing permissions.`);
                    }
                    const data = JSON.parse(text.substring(text.indexOf('(') + 1, text.lastIndexOf(')')));
                    if (data.status === 'error') { throw new Error(`API error for sheet ${sheetName}: ${data.errors[0]?.detailed_message}`); }
                    
                    const row = data.table.rows.find(r => r.c && String(r.c[2]?.v) === String(studentId));
                    if (row) {
                        const approvalStatus = row.c[8]?.v;
                        const leaveType = row.c[6]?.v;
                        if (approvalStatus === 'អនុញ្ញាត') { return leaveType || null; }
                    }
                    return null;
                } catch (error) { 
                    console.error(`Failed to fetch or parse data from ${sheetName}:`, error);
                    return { error: true, message: `Could not load data from ${sheetName}.` };
                }
            }
            
            function getTimeWindowsForSchedule(scheduleType, dayOfWeek) {
                const isFriday = dayOfWeek === 5;
                const trimmedSchedule = scheduleType ? String(scheduleType).trim() : null;
                switch(trimmedSchedule) {
                    case 'ពេញម៉ោង': return { checkInStart: '7:00AM', checkInEnd: '10:04AM', checkOutStart: isFriday ? '3:15PM' : '5:30PM', checkOutEnd: '8:04PM' };
                    case 'មួយព្រឹក': return { checkInStart: '7:00AM', checkInEnd: '10:04AM', checkOutStart: '11:30AM', checkOutEnd: '1:04PM' };
                    case 'មួយរសៀល': return { checkInStart: '11:00AM', checkInEnd: '1:44PM', checkOutStart: isFriday ? '3:15PM' : '5:30PM', checkOutEnd: '8:04PM' };
                    case 'ពេលយប់': return { checkInStart: '5:45PM', checkInEnd: '6:44PM', checkOutStart: '8:55PM', checkOutEnd: '10:04PM' };
                    default: 
                        if (scheduleType) { console.warn(`Unknown schedule type: '${scheduleType}'`); }
                        return null;
                }
            }
            
            function parseTime(now, timeStr) {
                const date = new Date(now);
                const match = timeStr.match(/(\d+):(\d+)(AM|PM)/i);
                if (!match) return null;
                let [_, hours, minutes, modifier] = match;
                hours = parseInt(hours, 10);
                minutes = parseInt(minutes, 10);
                if (modifier.toUpperCase() === 'PM' && hours < 12) hours += 12;
                if (modifier.toUpperCase() === 'AM' && hours === 12) hours = 0;
                date.setHours(hours, minutes, 0, 0);
                return date;
            };

            function isTimeInWindow(now, startStr, endStr) {
                const startTime = parseTime(now, startStr);
                const endTime = parseTime(now, endStr);
                return startTime && endTime && now >= startTime && now <= endTime;
            }
            
            function isDuringBreakTime() {
                const now = new Date();
                if (isTimeInWindow(now, '9:30AM', '9:50AM')) return true;
                if (isTimeInWindow(now, '11:30AM', '12:30PM')) return true;
                return false;
            }

            function isPointInPolygon(point, polygon) {
                let [latitude, longitude] = point;
                let inside = false;
                for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                    let [xi, yi] = polygon[i];
                    let [xj, yj] = polygon[j];
                    let intersect = ((yi > longitude) != (yj > longitude))
                        && (latitude < (xj - xi) * (longitude - yi) / (yj - yi) + xi);
                    if (intersect) inside = !inside;
                }
                return inside;
            }
            
            async function getAttendanceStatus(studentId) {
                if (APPS_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL') {
                    return { error: true, message: "Apps Script URL is not configured." };
                }
                try {
                    const response = await fetch(`${APPS_SCRIPT_URL}?action=getStatus&studentId=${studentId}&t=${new Date().getTime()}`);
                    if (!response.ok) { throw new Error(`Server error: ${response.status} ${response.statusText}`); }
                    const data = await response.json();
                     if (data.error) { throw new Error(`Server-side error: ${data.error}`); }
                    return data;
                } catch (error) {
                    console.error('getAttendanceStatus failed:', error);
                    return { error: true, message: `Could not connect to the attendance server.` };
                }
            }
            
            async function updateButtonStates() {
                checkInButton.disabled = true; 
                checkOutButton.disabled = true;
                statusMessage.textContent = 'កំពុងពិនិត្យស្ថានភាព...';
                try {
                    const [attendanceStatus, leaveStatus, crbLeaveStatus] = await Promise.all([
                        getAttendanceStatus(currentStudent.id),
                        fetchLeaveDataFromSheet(LEAVE_SHEET_ID, LEAVE_SHEET_NAME, currentStudent.id),
                        fetchLeaveDataFromSheet(CRB_LEAVE_SHEET_ID, CRB_LEAVE_SHEET_NAME, currentStudent.id)
                    ]);

                    if (attendanceStatus.error || leaveStatus?.error || crbLeaveStatus?.error) {
                        const errorMsg = attendanceStatus.error ? attendanceStatus.message 
                                     : (leaveStatus?.error ? leaveStatus.message : crbLeaveStatus.message);
                        throw new Error(errorMsg || "An unknown error occurred while fetching data.");
                    }

                    const now = new Date();
                    const dayMapping = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                    const todaySchedule = currentStudent.schedule[dayMapping[now.getDay()]];
                    let status = 'សូមស្វាគមន៍!'; let canCheckIn = false; let canCheckOut = false;

                    const cannotCheckIn = (leaveStatus === 'មួយព្រឹក' || leaveStatus === 'មួយថ្ងៃ') || (crbLeaveStatus === 'មួយព្រឹក' || crbLeaveStatus === 'មួយថ្ងៃ' || crbLeaveStatus === 'ពេលយប់');
                    const cannotCheckOut = (leaveStatus === 'មួយរសៀល' || leaveStatus === 'មួយថ្ងៃ') || (crbLeaveStatus === 'មួយរសៀល' || crbLeaveStatus === 'មួយថ្ងៃ' || crbLeaveStatus === 'ពេលយប់');
                    
                    const timeWindows = getTimeWindowsForSchedule(todaySchedule, now.getDay());
                    const isCheckOutTime = timeWindows ? isTimeInWindow(now, timeWindows.checkOutStart, timeWindows.checkOutEnd) : false;

                    if (attendanceStatus.checkIn && !attendanceStatus.checkOut) {
                        if (!isCurrentlyTracking) startLiveTracking();
                        if (!isCheckOutTime) {
                            startCheckoutCountdown(timeWindows);
                        } else {
                            stopCheckoutCountdown();
                        }
                    } else { 
                        stopLiveTracking(); 
                    }
                    
                    if (cannotCheckIn && cannotCheckOut) { status = 'អ្នកបានសុំច្បាប់មួយថ្ងៃ។'; }
                    else if (!timeWindows) { status = 'ថ្ងៃនេះមិនមានកាលវិភាគទេ។'; }
                    else {
                        const isCheckInTime = isTimeInWindow(now, timeWindows.checkInStart, timeWindows.checkInEnd);
                        const isCheckOutNow = isTimeInWindow(now, timeWindows.checkOutStart, timeWindows.checkOutEnd);

                        if (!cannotCheckIn && isCheckInTime && !attendanceStatus.checkIn) canCheckIn = true;
                        if (!cannotCheckOut && isCheckOutNow && attendanceStatus.checkIn && !attendanceStatus.checkOut) canCheckOut = true;
                        
                        if (attendanceStatus.checkIn && attendanceStatus.checkOut) { status = 'អ្នកបាន Check Out រួចរាល់សម្រាប់ថ្ងៃនេះ។'; }
                        else if (attendanceStatus.checkIn) { status = 'អ្នកបាន Check In រួចរាល់។'; }
                        else if (canCheckIn) { status = 'អ្នកអាច Check In បាន។'; }
                        else if (!isCheckInTime && !isCheckOutNow) { status = 'ផុតម៉ោងឆែកវត្តមានហើយ!!!'; }
                        else { status = cannotCheckIn && isCheckInTime ? 'អ្នកបានសុំច្បាប់ពេលព្រឹក។' : 'សូមរង់ចាំដល់ម៉ោង Check In / Out'; }
                    }
                    checkInButton.disabled = !canCheckIn; 
                    checkOutButton.disabled = !canCheckOut;
                    statusMessage.textContent = status;

                } catch (error) { 
                    statusMessage.textContent = error.message || 'មានបញ្ហាក្នុងការពិនិត្យស្ថានភាព។'; 
                    console.error("Error updating button states:", error);
                    checkInButton.disabled = true;
                    checkOutButton.disabled = true;
                }
            }
            
            function setButtonLoading(type, isLoading) {
                const button = type === 'Check In' ? checkInButton : checkOutButton;
                const content = type === 'Check In' ? checkInContent : checkOutContent;
                if (isLoading) {
                    button.disabled = true;
                    content.innerHTML = `<div class="flex items-center justify-center gap-2"><div class="spinner"></div><span>កំពុងដំណើរការ...</span></div>`;
                } else {
                     button.disabled = false;
                     const icon = type === 'Check In' 
                        ? `<svg class="w-10 h-10 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" /></svg>`
                        : `<svg class="w-10 h-10 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m-3 0l-3-3m0 0l3-3m-3 3H9" /></svg>`;
                    content.innerHTML = `${icon}<span class="text-lg mt-2">${type}</span>`;
                }
            }

            async function handleAttendanceClick(type) {
                setButtonLoading(type, true);
                statusMessage.textContent = 'កំពុងស្នើសុំទីតាំង...';
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true });
                    });

                    const { latitude, longitude } = position.coords;
                    const isInArea = isPointInPolygon([latitude, longitude], allowedAreaCoords);
                    
                    if (isInArea) {
                        const now = new Date();
                        const dayMapping = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                        const todaySchedule = currentStudent.schedule[dayMapping[now.getDay()]] || 'N/A';
                        const data = { action: type.replace(' ', ''), studentId: currentStudent.id, schedule: todaySchedule };
                        
                        const result = await postAttendanceData(data);
                        if (result.status === 'success') {
                            if (type === 'Check In') {
                                liveTrackingWarning.classList.remove('hidden');
                                setTimeout(async () => {
                                    liveTrackingWarning.classList.add('hidden');
                                    await updateButtonStates();
                                }, 3000);
                            } else {
                                stopLiveTracking();
                                await updateButtonStates();
                            }
                        } else {
                            throw new Error(result.message || 'Unknown error');
                        }
                    } else {
                        throw new Error('អ្នកមិនស្ថិតនៅក្នុងតំបន់កំណត់ទេ។');
                    }
                } catch (error) {
                    statusMessage.textContent = error.message || 'ការស្នើសុំទីតាំងបរាជ័យ។';
                    setButtonLoading(type, false);
                }
            }
            
            async function postAttendanceData(data) {
                if (data.action !== 'sendTelegramAlert') statusMessage.textContent = 'កំពុងរក្សាទុក...';
                try {
                    if (APPS_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL') throw new Error("URL is not configured.");
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST', body: JSON.stringify(data),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    });
                    if (!response.ok) throw new Error(`Server error: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (data.action !== 'sendTelegramAlert') statusMessage.textContent = 'ការរក្សាទុកបរាជ័យ។';
                    return { status: 'error', message: error.message };
                }
            }

            function startLiveTracking() {
                if (isCurrentlyTracking) return;
                isCurrentlyTracking = true; 
                telegramAlertSent = false;
                disconnectionLogged = false;
                stopLiveTracking();
                window.addEventListener('offline', () => handleDisconnection('signal', null));
                liveWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        if (isDuringBreakTime()) { handleReconnection(); return; }
                        const { latitude, longitude } = position.coords;
                        if (!isPointInPolygon([latitude, longitude], allowedAreaCoords)) {
                            handleDisconnection('geofence', position);
                        } else { handleReconnection(); }
                    }, 
                    (error) => handleDisconnection('signal', null),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }

            function stopLiveTracking() {
                isCurrentlyTracking = false;
                liveTrackingWarning.classList.add('hidden');
                stopCheckoutCountdown();
                if (liveWatchId) { navigator.geolocation.clearWatch(liveWatchId); liveWatchId = null; }
                if (disconnectionTimer) { clearTimeout(disconnectionTimer); disconnectionTimer = null; }
                window.removeEventListener('offline', () => handleDisconnection('signal', null));
            }

            function handleDisconnection(reason, position) {
                if (reason === 'geofence' && position && !telegramAlertSent) {
                    sendTelegramAlert(position);
                    telegramAlertSent = true;
                }
                if (disconnectionTimer) return;
                statusMessage.innerHTML = `<span class="text-red-500 font-bold">ព្រមាន៖ ${reason === 'geofence' ? 'បានចាកចេញពីតំបន់' : 'បាត់បង់សញ្ញា'}!</span>`;
                disconnectionTimer = setTimeout(async () => {
                    if (!disconnectionLogged) {
                        statusMessage.textContent = 'ការចាកចេញពីតំបន់ត្រូវបានកត់ត្រាទុក។';
                        const detail = `${reason === 'geofence' ? 'ចាកចេញពីតំបន់' : 'បាត់សញ្ញា'} >14s នៅម៉ោង ${new Date().toLocaleTimeString()}`;
                        const data = { action: 'LogDisconnection', studentId: currentStudent.id, detail: detail };
                        await postAttendanceData(data);
                        disconnectionLogged = true;
                    }
                    clearTimeout(disconnectionTimer);
                    disconnectionTimer = null;
                     setTimeout(updateButtonStates, 2000);
                }, 14000);
            }
            
            function handleReconnection() {
                telegramAlertSent = false;
                disconnectionLogged = false;
                if (disconnectionTimer) {
                    clearTimeout(disconnectionTimer);
                    disconnectionTimer = null;
                    statusMessage.textContent = 'ការតភ្ជាប់បានប្រសើរឡើងវិញ។';
                    setTimeout(updateButtonStates, 2000);
                }
            }
            
            async function sendTelegramAlert(position) {
                const { latitude, longitude } = position.coords;
                const data = { action: 'sendTelegramAlert', studentName: currentStudent.name, latitude, longitude };
                postAttendanceData(data); // Fire and forget
            }

            function startCheckoutCountdown(timeWindows) {
                stopCheckoutCountdown();
                const checkoutTime = parseTime(new Date(), timeWindows.checkOutStart);
                if (!checkoutTime || checkoutTime < new Date()) { return; }

                countdownModal.classList.remove('hidden');
                setTimeout(() => {
                    countdownModalContent.classList.remove('scale-95', 'opacity-0');
                }, 10);

                const totalDuration = checkoutTime.getTime() - new Date().getTime();

                function updateCountdown() {
                    const now = new Date();
                    const remainingTime = checkoutTime.getTime() - now.getTime();
                    if (remainingTime <= 0) {
                        stopCheckoutCountdown();
                        updateButtonStates();
                        return;
                    }

                    const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                    const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);

                    countdownHours.textContent = String(hours).padStart(2, '0');
                    countdownMinutes.textContent = String(minutes).padStart(2, '0');
                    countdownSeconds.textContent = String(seconds).padStart(2, '0');
                    
                    const progress = (totalDuration - remainingTime) / totalDuration;
                    const offset = circumference * (1 - progress);
                    countdownCircle.style.strokeDashoffset = offset;
                }
                updateCountdown();
                countdownInterval = setInterval(updateCountdown, 1000);
            }

            function stopCheckoutCountdown() {
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                countdownModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                   countdownModal.classList.add('hidden');
               }, 200);
            }

            function showLogoutModal() {
                logoutModal.classList.remove('hidden');
                setTimeout(() => logoutModalContent.classList.remove('scale-95', 'opacity-0'), 10);
            }
            function hideLogoutModal() {
                logoutModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => logoutModal.classList.add('hidden'), 200);
            }

            // --- Event Listeners ---
            classInput.addEventListener('change', handleClassChange);
            idInput.addEventListener('change', handleIdChange);
            closeModalButton.addEventListener('click', () => closeVerificationModal(true));
            retryButton.addEventListener('click', handleRetry);
            logoutButton.addEventListener('click', showLogoutModal);
            checkInButton.addEventListener('click', () => handleAttendanceClick('Check In'));
            checkOutButton.addEventListener('click', () => handleAttendanceClick('Check Out'));
            cancelLogoutButton.addEventListener('click', hideLogoutModal);
            confirmLogoutButton.addEventListener('click', () => { hideLogoutModal(); logout(); });
            
            checkForSavedSession();
        });
    </script>
</body>
</html>

