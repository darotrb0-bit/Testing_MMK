<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធគ្រប់គ្រងវត្តមានបុគ្គលិក</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Koulen&family=Moul&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Koulen', sans-serif;
            background-color: #f0f2f5;
        }
        .khmer-moul {
            font-family: 'Moul', cursive;
        }
        #reader {
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .scan-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: red;
            box-shadow: 0 0 10px red;
            animation: scan 2s infinite linear;
        }
        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-2xl overflow-hidden flex flex-col md:flex-row">
        
        <!-- Left Panel: Scanner and Info -->
        <div class="w-full md:w-1/2 p-6 md:p-8 flex flex-col bg-gray-50">
            <h1 class="khmer-moul text-3xl font-bold text-center text-blue-800 mb-2">ប្រព័ន្ធស្កេនវត្តមាន</h1>
            <div id="clock" class="text-center text-gray-600 mb-6 font-mono"></div>

            <div class="relative w-full aspect-square bg-gray-900 rounded-lg overflow-hidden mb-4 shadow-inner">
                <div id="reader"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="w-2/3 h-2/3 border-4 border-dashed border-gray-400 rounded-lg relative">
                         <div class="scan-line"></div>
                    </div>
                </div>
            </div>

             <div class="mb-4">
                <label for="employeeId" class="block text-sm font-medium text-gray-700 mb-1">ឬបញ្ចូលអត្តលេខបុគ្គលិក</label>
                <div class="flex">
                    <input type="text" id="employeeId" class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ឧ. EMP001">
                    <button id="checkIdBtn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-r-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">ស្វែងរក</button>
                </div>
            </div>

            <div id="loading" class="hidden text-center text-blue-600 my-4">
                <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p>...កំពុងដំណើរការ...</p>
            </div>
             <div id="message" class="text-center my-4 p-3 rounded-lg text-sm"></div>
        </div>

        <!-- Right Panel: Employee Details -->
        <div class="w-full md:w-1/2 p-6 md:p-8 flex flex-col items-center justify-center">
            <div id="employee-info" class="w-full text-center">
                <div class="w-32 h-32 bg-gray-200 rounded-full mx-auto mb-4 flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" class="w-20 h-20 text-gray-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                </div>
                <h2 id="employeeName" class="text-2xl font-bold text-gray-800">-</h2>
                <p id="employeeDetails" class="text-gray-500 mt-1">សូមស្កេន ឬបញ្ចូលអត្តលេខ</p>

                <div id="action-buttons" class="mt-8 space-x-4 hidden">
                    <button id="checkinBtn" class="bg-green-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-green-700 transition transform hover:scale-105">
                        CHECK IN
                    </button>
                    <button id="checkoutBtn" class="bg-red-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-red-700 transition transform hover:scale-105">
                        CHECK OUT
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    // ===================================================================================
    // សំខាន់! សូមបិទភ្ជាប់ Web App URL របស់អ្នកនៅទីនេះ
    // សូមអនុវត្តតាមឯកសារណែនាំដើម្បីទទួលបាន URL នេះ
    // ===================================================================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyUanRMEOzxaWChaEFjYiONCTk6WGaERRkz7qhD02y3NVoj4l6O0ry2pvpSj4vu4-qs/exec"; // <--- បិទភ្ជាប់ URL របស់អ្នកនៅទីនេះ
    // ===================================================================================

    const employeeIdInput = document.getElementById('employeeId');
    const checkIdBtn = document.getElementById('checkIdBtn');
    const employeeNameEl = document.getElementById('employeeName');
    const employeeDetailsEl = document.getElementById('employeeDetails');
    const actionButtons = document.getElementById('action-buttons');
    const checkinBtn = document.getElementById('checkinBtn');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const messageEl = document.getElementById('message');
    const loadingEl = document.getElementById('loading');
    const clockEl = document.getElementById('clock');
    
    let currentEmployeeId = null;

    // Clock
    function updateClock() {
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Phnom_Penh' };
        const date = now.toLocaleDateString('km-KH', options);
        const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true, timeZone: 'Asia/Phnom_Penh' });
        clockEl.textContent = `${date} | ${time}`;
    }
    setInterval(updateClock, 1000);
    updateClock();


    function showMessage(type, text) {
        messageEl.classList.remove('bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800', 'hidden');
        if (type === 'success') {
            messageEl.classList.add('bg-green-100', 'text-green-800');
        } else if (type === 'error') {
            messageEl.classList.add('bg-red-100', 'text-red-800');
        } else {
             messageEl.classList.add('bg-yellow-100', 'text-yellow-800');
        }
        messageEl.textContent = text;
        setTimeout(() => {
            messageEl.classList.add('hidden');
        }, 5000);
    }
    
    function resetUI() {
        employeeNameEl.textContent = '-';
        employeeDetailsEl.textContent = 'សូមស្កេន ឬបញ្ចូលអត្តលេខ';
        actionButtons.classList.add('hidden');
        employeeIdInput.value = '';
        currentEmployeeId = null;
    }

    async function fetchEmployeeData(id) {
        if (!SCRIPT_URL) {
            showMessage('error', 'សូមបញ្ចូល Web App URL នៅក្នុងកូដជាមុនសិន!');
            return;
        }
        loadingEl.classList.remove('hidden');
        messageEl.classList.add('hidden');
        actionButtons.classList.add('hidden');

        try {
            const response = await fetch(`${SCRIPT_URL}?action=getEmployee&id=${id}`);
            const result = await response.json();
            
            if (result.success) {
                const { name, gender } = result.data;
                employeeNameEl.textContent = name;
                employeeDetailsEl.textContent = `អត្តលេខ: ${id} | ភេទ: ${gender}`;
                actionButtons.classList.remove('hidden');
                currentEmployeeId = id;
                 showMessage('success', `ស្វាគមន៍, ${name}!`);
            } else {
                showMessage('error', result.message);
                resetUI();
            }
        } catch (error) {
            showMessage('error', 'មានបញ្ហាក្នុងការតភ្ជាប់ សូមព្យាយាមម្តងទៀត។');
            console.error('Error fetching employee data:', error);
            resetUI();
        } finally {
            loadingEl.classList.add('hidden');
        }
    }

    async function logAttendance(type) {
         if (!SCRIPT_URL) {
            showMessage('error', 'សូមបញ្ចូល Web App URL នៅក្នុងកូដជាមុនសិន!');
            return;
        }
        if (!currentEmployeeId) {
            showMessage('error', 'គ្មានព័ត៌មានបុគ្គលិក');
            return;
        }

        loadingEl.classList.remove('hidden');
        messageEl.classList.add('hidden');
        
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify({
                    action: 'logAttendance',
                    id: currentEmployeeId,
                    type: type
                })
            });
            const result = await response.json();
             if (result.success) {
                showMessage('success', result.message);
            } else {
                showMessage('error', result.message);
            }
        } catch (error) {
            showMessage('error', 'មានបញ្ហាក្នុងការកត់ត្រា សូមព្យាយាមម្តងទៀត។');
             console.error('Error logging attendance:', error);
        } finally {
            loadingEl.classList.add('hidden');
            setTimeout(resetUI, 3000);
        }
    }
    
    checkIdBtn.addEventListener('click', () => {
        const id = employeeIdInput.value.trim();
        if (id) {
            fetchEmployeeData(id);
        } else {
            showMessage('info', 'សូមបញ្ចូលអត្តលេខបុគ្គលិក');
        }
    });

    employeeIdInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            checkIdBtn.click();
        }
    });

    checkinBtn.addEventListener('click', () => logAttendance('checkin'));
    checkoutBtn.addEventListener('click', () => logAttendance('checkout'));

    // QR Code Scanner
    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Code matched = ${decodedText}`, decodedResult);
        employeeIdInput.value = decodedText;
        fetchEmployeeData(decodedText);
        html5QrcodeScanner.clear(); // Stop scanning after success
    }

    function onScanFailure(error) {
        // console.warn(`Code scan error = ${error}`);
    }

    let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader",
        { fps: 10, qrbox: {width: 250, height: 250} },
        false
    );
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);

</script>
</body>
</html>
